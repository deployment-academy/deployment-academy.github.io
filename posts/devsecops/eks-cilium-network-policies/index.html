<!doctype html><html class=no-js lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><title>Using Network Policies in EKS with Cilium - Deployment</title><script>(function(e,t){e[t]=e[t].replace("no-js","js")})(document.documentElement,"className")</script><meta name=description content="In this tutorial, we will deploy Cilium to an Amazon EKS cluster and limit traffic to Pods using Kubernetes Network Policies."><meta property="og:title" content="Using Network Policies in EKS with Cilium"><meta property="og:description" content="In this tutorial, we will deploy Cilium to an Amazon EKS cluster and limit traffic to Pods using Kubernetes Network Policies."><meta property="og:type" content="article"><meta property="og:url" content="https://deployment.properties/posts/devsecops/eks-cilium-network-policies/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-09-26T14:15:28-04:00"><meta property="article:modified_time" content="2022-05-21T20:28:19-04:00"><meta itemprop=name content="Using Network Policies in EKS with Cilium"><meta itemprop=description content="In this tutorial, we will deploy Cilium to an Amazon EKS cluster and limit traffic to Pods using Kubernetes Network Policies."><meta itemprop=datePublished content="2021-09-26T14:15:28-04:00"><meta itemprop=dateModified content="2022-05-21T20:28:19-04:00"><meta itemprop=wordCount content="1273"><meta itemprop=keywords content="devsecops,kubernetes,aws,eks,network policies,cilium,"><meta name=twitter:card content="summary"><meta name=twitter:title content="Using Network Policies in EKS with Cilium"><meta name=twitter:description content="In this tutorial, we will deploy Cilium to an Amazon EKS cluster and limit traffic to Pods using Kubernetes Network Policies."><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=dns-prefetch href=//fonts.googleapis.com><link rel=dns-prefetch href=//fonts.gstatic.com><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700"><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=/css/custom.css><link rel="shortcut icon" href=/favicon.ico><script async src="https://www.googletagmanager.com/gtag/js?id=G-0BJEGTESYY"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-0BJEGTESYY",{anonymize_ip:!1})}</script></head><body class=body><div class="container container--outer"><header class=header><div class="container header__container"><div class=logo><a class=logo__link href=/ title=Deployment rel=home><div class="logo__item logo__text"><div class=logo__title>Deployment</div><div class=logo__tagline>A tech blog focused on Software Engineering and DevSecOps</div></div></a></div><nav class=menu><button class=menu__btn aria-haspopup=true aria-expanded=false tabindex=0>
<span class=menu__btn-title tabindex=-1>Menu</span></button><ul class=menu__list><li class=menu__item><a class=menu__link href=/about/><span class=menu__text>About</span></a></li></ul></nav></div></header><div class="wrapper flex"><div class=primary><main class=main role=main><article class=post><header class=post__header><h1 class=post__title>Using Network Policies in EKS with Cilium</h1><div class="post__meta meta"><div class="meta__item-author meta__item"><svg class="meta__icon icon icon-author" width="16" height="16" viewBox="0 0 12 16"><path d="M6 1c2.2.0 3.5 2 3.5 4.5C9.5 7 8.9 8.2 8 9c2.9.8 4 2.5 4 5v1H0v-1c0-2.5 1.1-4.2 4-5-.9-.8-1.5-2-1.5-3.5C2.5 3 3.8 1 6 1z"/></svg><span class=meta__text>Romulo Santos</span></div><div class="meta__item-datetime meta__item"><svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0C7 0 1 6 1 14s6 14 14 14 14-6 14-14S23 0 15 0zm0 25C9 25 4 20 4 14S9 3 15 3s11 5 11 11-5 11-11 11zm1-18h-2v8.4l6.8 4.4L22 18l-6-3.8V7z"/></svg><time class=meta__text datetime=2021-09-26T14:15:28-04:00>2021-09-26</time>
<time class=meta__text datetime=2022-05-21T20:28:19-04:00>(Last Modified: 2022-05-21)</time></div></div></header><div class="content post__content clearfix"><p>In this tutorial, we will deploy <a href=https://cilium.io/>Cilium</a> to an <a href=https://docs.aws.amazon.com/eks/latest/userguide/getting-started.html>Amazon EKS</a> cluster and limit traffic to Pods using Kubernetes <a href=https://kubernetes.io/docs/concepts/services-networking/network-policies/>Network Policies</a>.</p><p>Network Policies are not available in Kubernetes out-of-the-box. To leverage Network Policies, you must use a <a href=https://kubernetes.io/docs/concepts/extend-kubernetes/compute-storage-net/network-plugins/>network plugin</a> that implements such a feature - here is where Cilium comes into play.</p><p>It&rsquo;s worth noting that while this is the scope of this tutorial, Cilium is not limited to Network Policies and not even limited to Kubernetes. Check the <a href=https://docs.cilium.io/en/stable/intro/>Introduction to Cilium</a> to learn more about it and the <a href=https://docs.cilium.io/en/stable/concepts/kubernetes/intro/>Kubernetes Integration doc</a> about how Cilium works with Kubernetes.</p><h2 id=prerequisites>Prerequisites</h2><p>To follow this tutorial, you need an <a href=https://aws.amazon.com/account/>AWS Account</a> and credentials to create and manage an EKS cluster properly provisioned and installed in your local environment. You also need the <code>eksctl</code> and <code>kubectl</code> CLIs installed.</p><p>Check the <a href=https://docs.aws.amazon.com/eks/latest/userguide/getting-started-eksctl.html#eksctl-prereqs>Getting started with Amazon EKS â€“ eksctl Prerequisites</a> section if you need help.</p><h2 id=create-the-eks-cluster>Create the EKS cluster</h2><style type=text/css>.notice{padding:18px;line-height:24px;margin-bottom:24px;border-radius:4px;color:#444;background:#e7f2fa;text-align:left}.notice p:last-child{margin-bottom:0}.notice-title{margin:-18px -18px 12px;padding:4px 18px;border-radius:4px 4px 0 0;font-weight:700;color:#fff;background:#6ab0de;text-align:left}.notice.warning .notice-title{background:rgba(217,83,79,.9)}.notice.warning{background:#fae2e2}.notice.info .notice-title{background:#f0b37e}.notice.info{background:#fff2db}.notice.note .notice-title{background:#6ab0de}.notice.note{background:#e7f2fa}.notice.tip .notice-title{background:rgba(92,184,92,.8)}.notice.tip{background:#e6f9e6}.icon-notice{display:inline-flex;align-self:center;margin-right:8px}.icon-notice img,.icon-notice svg{height:1em;width:1em;fill:currentColor}.icon-notice img,.icon-notice.baseline svg{top:.125em;position:relative}</style><div><svg width="0" height="0" display="none" xmlns="http://www.w3.org/2000/svg"><symbol id="tip-notice" viewBox="0 0 512 512" preserveAspectRatio="xMidYMid meet"><path d="M504 256c0 136.967-111.033 248-248 248S8 392.967 8 256 119.033 8 256 8s248 111.033 248 248zM227.314 387.314l184-184c6.248-6.248 6.248-16.379.0-22.627l-22.627-22.627c-6.248-6.249-16.379-6.249-22.628.0L216 308.118l-70.059-70.059c-6.248-6.248-16.379-6.248-22.628.0l-22.627 22.627c-6.248 6.248-6.248 16.379.0 22.627l104 104c6.249 6.249 16.379 6.249 22.628.001z"/></symbol><symbol id="note-notice" viewBox="0 0 512 512" preserveAspectRatio="xMidYMid meet"><path d="M504 256c0 136.997-111.043 248-248 248S8 392.997 8 256C8 119.083 119.043 8 256 8s248 111.083 248 248zm-248 50c-25.405.0-46 20.595-46 46s20.595 46 46 46 46-20.595 46-46-20.595-46-46-46zm-43.673-165.346 7.418 136c.347 6.364 5.609 11.346 11.982 11.346h48.546c6.373.0 11.635-4.982 11.982-11.346l7.418-136c.375-6.874-5.098-12.654-11.982-12.654h-63.383c-6.884.0-12.356 5.78-11.981 12.654z"/></symbol><symbol id="warning-notice" viewBox="0 0 576 512" preserveAspectRatio="xMidYMid meet"><path d="M569.517 440.013C587.975 472.007 564.806 512 527.94 512H48.054c-36.937.0-59.999-40.055-41.577-71.987L246.423 23.985c18.467-32.009 64.72-31.951 83.154.0l239.94 416.028zM288 354c-25.405.0-46 20.595-46 46s20.595 46 46 46 46-20.595 46-46-20.595-46-46-46zm-43.673-165.346 7.418 136c.347 6.364 5.609 11.346 11.982 11.346h48.546c6.373.0 11.635-4.982 11.982-11.346l7.418-136c.375-6.874-5.098-12.654-11.982-12.654h-63.383c-6.884.0-12.356 5.78-11.981 12.654z"/></symbol><symbol id="info-notice" viewBox="0 0 512 512" preserveAspectRatio="xMidYMid meet"><path d="M256 8C119.043 8 8 119.083 8 256c0 136.997 111.043 248 248 248s248-111.003 248-248C504 119.083 392.957 8 256 8zm0 110c23.196.0 42 18.804 42 42s-18.804 42-42 42-42-18.804-42-42 18.804-42 42-42zm56 254c0 6.627-5.373 12-12 12h-88c-6.627.0-12-5.373-12-12v-24c0-6.627 5.373-12 12-12h12v-64h-12c-6.627.0-12-5.373-12-12v-24c0-6.627 5.373-12 12-12h64c6.627.0 12 5.373 12 12v1e2h12c6.627.0 12 5.373 12 12v24z"/></symbol></svg></div><div class="notice warning" id=minimal-configuration><p class="first notice-title"><span class="icon-notice baseline"><svg><use href="#warning-notice"/></svg></span>Quick note about minimal configuration</p><p>Note that in this tutorial (and all other tutorials in this blog, unless said the contrary), we will use minimal configuration to get things running quickly and focus on the feature we are evaluating. <strong>Never use this configuration to set up a production environment.</strong> Refer to the official installation guides linked in the tutorial for more thorough instructions.</p></div><p>Declare some variables that we&rsquo;ll use throughout the tutorial.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cluster_name<span style=color:#f92672>=</span>le-cluster
</span></span><span style=display:flex><span>cluster_region<span style=color:#f92672>=</span>us-east-1  
</span></span></code></pre></div><p>Create the cluster.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>eksctl create cluster --name $cluster_name --region $cluster_region
</span></span></code></pre></div><p>Check the <code>eksctl</code> docs for more details about <a href=https://eksctl.io/usage/creating-and-managing-clusters/>creating and managing EKS clusters</a>.</p><p>Verify that your kube-config is currently pointing to the created cluster.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl config current-context
</span></span></code></pre></div><p>You can also check the nodes for more details about your installation.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get nodes -o wide
</span></span></code></pre></div><h2 id=install-cilium>Install Cilium</h2><p>Download the Cilium CLI.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -L https://github.com/cilium/cilium-cli/releases/latest/download/cilium-darwin-amd64.tar.gz <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -o cilium-darwin-amd64.tar.gz ; tar xzvf $_
</span></span></code></pre></div><p>Run the install command.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>./cilium install
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>...<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>Auto-detected IPAM mode: eni
</span></span><span style=display:flex><span>Auto-detected datapath mode: aws-eni
</span></span><span style=display:flex><span>Custom datapath mode: aws-eni
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>...<span style=color:#f92672>]</span>
</span></span></code></pre></div><p>The <code>cilium install</code> command uses your current kube context to detect the best configuration for your Kubernetes distribution and perform the installation. As you can see in the partial output listed above, Cilium is being installed on <a href=https://docs.cilium.io/en/stable/concepts/networking/ipam/eni/#ipam-eni>AWS ENI</a> mode. It&rsquo;s also possible to use Cilium with the <a href=https://docs.cilium.io/en/stable/gettingstarted/cni-chaining-aws-cni/#chaining-aws-cni>AWS VPC CNI plugin</a> - refer to the docs for more details.</p><p>When the installation finishes, you can check that Cilium is running with the CLI using:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>./cilium status --wait
</span></span></code></pre></div><p>and validate the installation with:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>./cilium connectivity test
</span></span></code></pre></div><p>To manually check that Cilium is running you can also check that the Cilium Pods are in running status.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get po -n kube-system
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>NAMESPACE     NAME                               READY   STATUS    RESTARTS   AGE
</span></span><span style=display:flex><span>kube-system   cilium-9vnf8                       1/1     Running   <span style=color:#ae81ff>0</span>          3m43s
</span></span><span style=display:flex><span>kube-system   cilium-bjdb4                       1/1     Running   <span style=color:#ae81ff>0</span>          3m43s
</span></span><span style=display:flex><span>kube-system   cilium-operator-7c9b465f5c-blk4w   1/1     Running   <span style=color:#ae81ff>0</span>          3m43s
</span></span><span style=display:flex><span>kube-system   coredns-7d74b564bd-2d2t9           1/1     Running   <span style=color:#ae81ff>0</span>          3m34s
</span></span><span style=display:flex><span>kube-system   coredns-7d74b564bd-tkxgp           1/1     Running   <span style=color:#ae81ff>0</span>          3m19s
</span></span><span style=display:flex><span>kube-system   kube-proxy-cnvph                   1/1     Running   <span style=color:#ae81ff>0</span>          23m
</span></span><span style=display:flex><span>kube-system   kube-proxy-hzkt9                   1/1     Running   <span style=color:#ae81ff>0</span>          23m
</span></span></code></pre></div><p>Note that when running Cilium in an autoscaling cluster, you&rsquo;ll want to add the <code>node.cilium.io/agent-not-ready=true:NoSchedule</code> taint to the nodes to prevent that Pods are scheduled in the node before Cilium is ready. Check the <a href=https://docs.cilium.io/en/stable/gettingstarted/k8s-install-default/>Cilium installation guide</a> for more details.</p><h2 id=deploy-a-demo-application>Deploy a Demo Application</h2><p>Let&rsquo;s deploy a demo application to perform some tests.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>git clone https://github.com/microservices-demo/microservices-demo
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>kubectl create namespace sock-shop
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>kubectl apply -f microservices-demo/deploy/kubernetes/complete-demo.yaml
</span></span></code></pre></div><p><a href=https://microservices-demo.github.io/>Sock Shop</a> is an application that implements an online socks shop and is usually used to demonstrate and test microservices and cloud-native technologies.</p><p>Wait until all the Pods are in running status.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>watch <span style=color:#e6db74>&#39;kubectl get po -n sock-shop&#39;</span>
</span></span><span style=display:flex><span>NAME                            READY   STATUS    RESTARTS   AGE
</span></span><span style=display:flex><span>carts-b4d4ffb5c-t8w2r           1/1     Running   <span style=color:#ae81ff>0</span>          3m45s
</span></span><span style=display:flex><span>carts-db-6c6c68b747-5wdm7       1/1     Running   <span style=color:#ae81ff>0</span>          3m45s
</span></span><span style=display:flex><span>catalogue-5bd97b4988-dsg6b      1/1     Running   <span style=color:#ae81ff>0</span>          3m45s
</span></span><span style=display:flex><span>catalogue-db-96f6f6b4c-dbwts    1/1     Running   <span style=color:#ae81ff>0</span>          3m45s
</span></span><span style=display:flex><span>front-end-6649c54d45-p7c66      1/1     Running   <span style=color:#ae81ff>0</span>          3m44s
</span></span><span style=display:flex><span>orders-7664c64d75-ffw4d         1/1     Running   <span style=color:#ae81ff>0</span>          3m44s
</span></span><span style=display:flex><span>orders-db-659949975f-x7cqq      1/1     Running   <span style=color:#ae81ff>0</span>          3m44s
</span></span><span style=display:flex><span>payment-dd67fc96f-rvrx4         1/1     Running   <span style=color:#ae81ff>0</span>          3m44s
</span></span><span style=display:flex><span>queue-master-5f6d6d4796-vx4f5   1/1     Running   <span style=color:#ae81ff>0</span>          3m44s
</span></span><span style=display:flex><span>rabbitmq-5bcbb547d7-z7bxf       2/2     Running   <span style=color:#ae81ff>0</span>          3m43s
</span></span><span style=display:flex><span>session-db-7cf97f8d4f-w8mhg     1/1     Running   <span style=color:#ae81ff>0</span>          3m43s
</span></span><span style=display:flex><span>shipping-7f7999ffb7-4bnhj       1/1     Running   <span style=color:#ae81ff>0</span>          3m43s
</span></span><span style=display:flex><span>user-888469b9f-lcv4n            1/1     Running   <span style=color:#ae81ff>0</span>          3m43s
</span></span><span style=display:flex><span>user-db-6df7444fc-77ht7         1/1     Running   <span style=color:#ae81ff>0</span>          3m43s
</span></span></code></pre></div><p>When the Pods are running, you can optionally test it locally by port-fowarding the <code>frond-end</code> service.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl port-forward service/front-end -n sock-shop 8080:80
</span></span></code></pre></div><p>You can now access it on the browser at <a href=http://localhost:8080>localhost:8080</a>. Use the username and password <code>user / password</code> to login.</p><h2 id=lateral-movement>Lateral Movement</h2><p>As you can see in the <a href=https://github.com/microservices-demo/microservices-demo/blob/master/internal-docs/design.md#architecture>Architecture Diagram</a>, this application has a few components. Among them is the <code>user</code> component that interacts with the <code>user-db</code>, which is a <a href=https://www.mongodb.com/>MongoDB</a> instance used to store users&rsquo; information.</p><p>We will play the role of a malicious actor that has gained access to create a Pod in our cluster and use this access to connect to the <code>user-db</code>.</p><p>List the services and observe the <code>users-db</code> service responding on port <code>27017</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get svc -n sock-shop
</span></span></code></pre></div><p>Let&rsquo;s launch a temporary Pod in interactive mode using the <code>mongo</code> image to execute commands against the <code>user-db</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl run rogue-1 --image<span style=color:#f92672>=</span>mongo:3.2 --restart<span style=color:#f92672>=</span>Never --rm -it -- /bin/bash
</span></span></code></pre></div><p>From inside the container run the following command to connect to the MongoDB instance:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>root@rogue-1:/# mongo --host user-db.sock-shop.svc.cluster.local:27017
</span></span></code></pre></div><p>Now, from the mongo session, run:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>&gt; show dbs
</span></span><span style=display:flex><span>local  0.000GB
</span></span><span style=display:flex><span>users  0.000GB
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>&gt; use users
</span></span><span style=display:flex><span>switched to db users
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>&gt; show collections
</span></span><span style=display:flex><span>addresses
</span></span><span style=display:flex><span>cards
</span></span><span style=display:flex><span>customers
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>&gt; db.cards.find<span style=color:#f92672>()</span>
</span></span><span style=display:flex><span><span style=color:#f92672>{</span> <span style=color:#e6db74>&#34;_id&#34;</span> : ObjectId<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;57a98d98e4b00679b4a830ae&#34;</span><span style=color:#f92672>)</span>, <span style=color:#e6db74>&#34;longNum&#34;</span> : <span style=color:#e6db74>&#34;5953580604169678&#34;</span>, <span style=color:#e6db74>&#34;expires&#34;</span> : <span style=color:#e6db74>&#34;08/19&#34;</span>, <span style=color:#e6db74>&#34;ccv&#34;</span> : <span style=color:#e6db74>&#34;678&#34;</span> <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>{</span> <span style=color:#e6db74>&#34;_id&#34;</span> : ObjectId<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;57a98d98e4b00679b4a830b1&#34;</span><span style=color:#f92672>)</span>, <span style=color:#e6db74>&#34;longNum&#34;</span> : <span style=color:#e6db74>&#34;5544154011345918&#34;</span>, <span style=color:#e6db74>&#34;expires&#34;</span> : <span style=color:#e6db74>&#34;08/19&#34;</span>, <span style=color:#e6db74>&#34;ccv&#34;</span> : <span style=color:#e6db74>&#34;958&#34;</span> <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>{</span> <span style=color:#e6db74>&#34;_id&#34;</span> : ObjectId<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;57a98d98e4b00679b4a830b4&#34;</span><span style=color:#f92672>)</span>, <span style=color:#e6db74>&#34;longNum&#34;</span> : <span style=color:#e6db74>&#34;0908415193175205&#34;</span>, <span style=color:#e6db74>&#34;expires&#34;</span> : <span style=color:#e6db74>&#34;08/19&#34;</span>, <span style=color:#e6db74>&#34;ccv&#34;</span> : <span style=color:#e6db74>&#34;280&#34;</span> <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>{</span> <span style=color:#e6db74>&#34;_id&#34;</span> : ObjectId<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;57a98ddce4b00679b4a830d2&#34;</span><span style=color:#f92672>)</span>, <span style=color:#e6db74>&#34;longNum&#34;</span> : <span style=color:#e6db74>&#34;5429804235432&#34;</span>, <span style=color:#e6db74>&#34;expires&#34;</span> : <span style=color:#e6db74>&#34;04/16&#34;</span>, <span style=color:#e6db74>&#34;ccv&#34;</span> : <span style=color:#e6db74>&#34;432&#34;</span> <span style=color:#f92672>}</span>
</span></span></code></pre></div><h2 id=kubernetes-network-policies>Kubernetes Network Policies</h2><p>Let&rsquo;s use a <a href=https://kubernetes.io/docs/concepts/services-networking/network-policies/>Kubernetes Network Policy</a> to restrict ingress traffic to the <code>users-db</code> Pod to only traffic from the <code>users</code> Pod.</p><p>To create this Network Policy, we need to know the labels used for each of these Pods. We can check this by running:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl describe deploy user-db -n sock-shop
</span></span><span style=display:flex><span>Name:                   user-db
</span></span><span style=display:flex><span>Namespace:              sock-shop
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>...<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>Pod Template:
</span></span><span style=display:flex><span>  Labels:  name<span style=color:#f92672>=</span>user-db
</span></span><span style=display:flex><span>  Containers:
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>...<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>kubectl describe deploy user -n sock-shop
</span></span><span style=display:flex><span>Name:                   user
</span></span><span style=display:flex><span>Namespace:              sock-shop
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>...<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>Pod Template:
</span></span><span style=display:flex><span>  Labels:  name<span style=color:#f92672>=</span>user
</span></span><span style=display:flex><span>  Containers:
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>...<span style=color:#f92672>]</span>
</span></span></code></pre></div><p>Note the Pod labels <code>name=user-db</code> and <code>name=user</code>.</p><p>Create the Network Policy.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f- <span style=color:#e6db74>&lt;&lt; EOF
</span></span></span><span style=display:flex><span><span style=color:#e6db74>kind: NetworkPolicy
</span></span></span><span style=display:flex><span><span style=color:#e6db74>apiVersion: networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#e6db74>metadata:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  name: user-db-allow-from-user
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  namespace: sock-shop
</span></span></span><span style=display:flex><span><span style=color:#e6db74>spec:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  policyTypes:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  - Ingress
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  PodSelector:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    matchLabels:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      name: user-db
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  ingress:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  - from:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    - PodSelector:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        matchLabels:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          name: user
</span></span></span><span style=display:flex><span><span style=color:#e6db74>EOF</span>
</span></span></code></pre></div><p>Create a temporary Pod again and try to connect to the MongoDB instance.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl run rogue-1 --image<span style=color:#f92672>=</span>mongo:3.2 --restart<span style=color:#f92672>=</span>Never --rm -it -- /bin/bash
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>root@rogue-1:/# mongo --host user-db.sock-shop.svc.cluster.local:27017
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>...<span style=color:#f92672>]</span>
</span></span></code></pre></div><p>It should fail now.</p><div class="notice tip" id=k8s-security><p class="first notice-title"><span class="icon-notice baseline"><svg><use href="#tip-notice"/></svg></span>A note on Kubernetes Security</p><p>The goal of this tutorial is to check how Cilium works with EKS allowing us to experiment with Network Policies and other features. The focus is not to provide best practices on how to secure your Kubernetes cluster. For instance, notice that a malicious actor, depending on the level of access that has been granted, can use different approaches to bypass this policy and get access to PII data or lead to service disruption. To properly secure your cluster, you should consider a combination of techniques such as using an <a href=https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/>Admission Controller</a> (e.g. <a href=https://www.openpolicyagent.org/docs/latest/kubernetes-introduction/#what-is-opa-gatekeeper>Gatekeeper</a> or <a href=https://kyverno.io/docs/introduction/>Kyverno</a>); tuned <a href=https://kubernetes.io/docs/reference/access-authn-authz/rbac/>RBAC</a> permissions; proper monitoring and alerting on suspicious behavior (e.g. <a href=https://falco.org/docs/>Falco</a>); among others.</p></div><p>Access the application on the browser at <a href=http://localhost:8080>localhost:8080</a> and verify that everything is still working fine.</p><p>Besides being able to use standard Kubernetes Network Policies, Cilium also allows you to use <a href=https://docs.cilium.io/en/stable/concepts/kubernetes/policy/#ciliumnetworkpolicy>CiliumNetworkPolicy</a> and <a href=https://docs.cilium.io/en/stable/concepts/kubernetes/policy/#ciliumclusterwidenetworkpolicy>CiliumClusterwideNetworkPolicy</a> that extend the standard policies, providing <a href=https://docs.cilium.io/en/stable/concepts/kubernetes/intro/#what-does-cilium-provide-in-your-kubernetes-cluster>more capabilities</a>. See the <a href=https://docs.cilium.io/en/stable/gettingstarted/#network-policy-security-tutorials>Network Policies tutorials</a> for examples. It&rsquo;s also worth taking a look at the <a href=https://docs.cilium.io/en/stable/intro/#functionality-overview>functionality overview doc</a> for a list of Cilium features that go beyond Network Policies.</p><h2 id=clean-up>Clean up</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>eksctl delete cluster --name $cluster_name --region $cluster_region
</span></span></code></pre></div></div><footer class=post__footer><div class="post__tags tags clearfix"><svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M32 19c0 1-1 2-1 2L21 31s-1 1-2 1-2-1-2-1L2 16c-1-1-1.4-2-1.4-2S0 12.5.0 11V3C0 1.5.8.8.8.8S1.5.0 3 0h8c1.5.0 3 .6 3 .6S15 1 16 2l15 15s1 1 1 2zM7 10a3 3 0 100-6 3 3 0 000 6z"/></svg><ul class=tags__list><li class=tags__item><a class="tags__link btn" href=/tags/devsecops/ rel=tag>devsecops</a></li><li class=tags__item><a class="tags__link btn" href=/tags/kubernetes/ rel=tag>kubernetes</a></li><li class=tags__item><a class="tags__link btn" href=/tags/aws/ rel=tag>aws</a></li><li class=tags__item><a class="tags__link btn" href=/tags/eks/ rel=tag>eks</a></li><li class=tags__item><a class="tags__link btn" href=/tags/network-policies/ rel=tag>network policies</a></li><li class=tags__item><a class="tags__link btn" href=/tags/cilium/ rel=tag>cilium</a></li></ul></div></footer></article></main></div></div><footer class=footer><div class="container footer__container flex"><div class=footer__copyright>&copy; 2022 Deployment - A tech blog focused on Software Engineering and DevSecOps.
<span class=footer__copyright-credits>Generated with <a href=https://gohugo.io/ rel="nofollow noopener" target=_blank>Hugo</a> and <a href=https://github.com/Vimux/Mainroad/ rel="nofollow noopener" target=_blank>Mainroad</a> theme.</span></div></div></footer></div><script async defer src=/js/menu.js></script>
<script src=/js/custom.js></script></body></html>