<!doctype html><html class=no-js lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><title>GKE Dataplane V2 and Network Policies in Practice - Deployment</title><script>(function(e,t){e[t]=e[t].replace("no-js","js")})(document.documentElement,"className")</script><meta name=description content="In this tutorial, we are going to play with the Google Kubernetes Engine Dataplane V2 and check how we can use it along with Kubernetes Network Policies to limit traffic to Pods and to obtain real-time visibility on cluster network activity."><meta property="og:title" content="GKE Dataplane V2 and Network Policies in Practice"><meta property="og:description" content="In this tutorial, we are going to play with the Google Kubernetes Engine Dataplane V2 and check how we can use it along with Kubernetes Network Policies to limit traffic to Pods and to obtain real-time visibility on cluster network activity."><meta property="og:type" content="article"><meta property="og:url" content="https://deployment.properties/posts/devsecops/gke-dataplane-v2-network-policies/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-09-18T13:48:06-04:00"><meta property="article:modified_time" content="2022-05-21T20:28:19-04:00"><meta itemprop=name content="GKE Dataplane V2 and Network Policies in Practice"><meta itemprop=description content="In this tutorial, we are going to play with the Google Kubernetes Engine Dataplane V2 and check how we can use it along with Kubernetes Network Policies to limit traffic to Pods and to obtain real-time visibility on cluster network activity."><meta itemprop=datePublished content="2021-09-18T13:48:06-04:00"><meta itemprop=dateModified content="2022-05-21T20:28:19-04:00"><meta itemprop=wordCount content="1611"><meta itemprop=keywords content="devsecops,kubernetes,gcp,google cloud,gke,dataplane v2,network policies,cilium,"><meta name=twitter:card content="summary"><meta name=twitter:title content="GKE Dataplane V2 and Network Policies in Practice"><meta name=twitter:description content="In this tutorial, we are going to play with the Google Kubernetes Engine Dataplane V2 and check how we can use it along with Kubernetes Network Policies to limit traffic to Pods and to obtain real-time visibility on cluster network activity."><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=dns-prefetch href=//fonts.googleapis.com><link rel=dns-prefetch href=//fonts.gstatic.com><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700"><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=/css/custom.css><link rel="shortcut icon" href=/favicon.ico><script async src="https://www.googletagmanager.com/gtag/js?id=G-0BJEGTESYY"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-0BJEGTESYY",{anonymize_ip:!1})}</script></head><body class=body><div class="container container--outer"><header class=header><div class="container header__container"><div class=logo><a class=logo__link href=/ title=Deployment rel=home><div class="logo__item logo__text"><div class=logo__title>Deployment</div><div class=logo__tagline>A tech blog focused on DevSecOps</div></div></a></div><nav class=menu><button class=menu__btn aria-haspopup=true aria-expanded=false tabindex=0>
<span class=menu__btn-title tabindex=-1>Menu</span></button><ul class=menu__list><li class=menu__item><a class=menu__link href=/about/><span class=menu__text>About</span></a></li></ul></nav></div></header><div class="wrapper flex"><div class=primary><main class=main role=main><article class=post><header class=post__header><h1 class=post__title>GKE Dataplane V2 and Network Policies in Practice</h1><div class="post__meta meta"><div class="meta__item-author meta__item"><svg class="meta__icon icon icon-author" width="16" height="16" viewBox="0 0 12 16"><path d="M6 1c2.2.0 3.5 2 3.5 4.5C9.5 7 8.9 8.2 8 9c2.9.8 4 2.5 4 5v1H0v-1c0-2.5 1.1-4.2 4-5-.9-.8-1.5-2-1.5-3.5C2.5 3 3.8 1 6 1z"/></svg><span class=meta__text>Romulo Santos</span></div><div class="meta__item-datetime meta__item"><svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0C7 0 1 6 1 14s6 14 14 14 14-6 14-14S23 0 15 0zm0 25C9 25 4 20 4 14S9 3 15 3s11 5 11 11-5 11-11 11zm1-18h-2v8.4l6.8 4.4L22 18l-6-3.8V7z"/></svg><time class=meta__text datetime=2021-09-18T13:48:06-04:00>2021-09-18</time>
<time class=meta__text datetime=2022-05-21T20:28:19-04:00>(Last Modified: 2022-05-21)</time></div></div></header><div class="content post__content clearfix"><p>In this tutorial, we are going to play with the <a href=https://cloud.google.com/kubernetes-engine/docs/concepts/dataplane-v2>Google Kubernetes Engine Dataplane V2</a> and check how we can use it along with <a href=https://kubernetes.io/docs/concepts/services-networking/network-policies/>Kubernetes Network Policies</a> to limit traffic to Pods and to obtain real-time visibility on cluster network activity.</p><p>Dataplane V2 is a <a href=https://cloud.google.com/blog/products/containers-kubernetes/bringing-ebpf-and-cilium-to-google-kubernetes-engine>recent feature in GKE</a>, with GA starting on version 1.20.6-gke.700 as of May 10, 2021. It uses <a href=https://cilium.io/>Cilium</a> to process network packets in-kernel using Kubernetes-specific metadata without relying on the kube-proxy and iptables for service routing, resulting in performance improvements. Dataplane V2 brings some exciting features for cluster operations and security, such as:</p><ul><li>Built-in Network Policies enforcement without the need of Calico and;</li><li>Real-time visibility, enabling cluster networking troubleshooting, auditing, and alerting.</li></ul><p>See the <a href=https://cloud.google.com/kubernetes-engine/docs/concepts/dataplane-v2>Dataplane V2 documentation</a> for more details.</p><h2 id=prerequisites>Prerequisites</h2><p>To follow this tutorial, you need a <a href="https://console.cloud.google.com/cloud-resource-manager?pli=1">Google Cloud project created</a> with <a href=https://cloud.google.com/billing/docs/how-to/modify-project>billing enabled</a>.</p><p>Also, make sure you have the most recent version of the <code>gcloud</code> CLI installed. See <a href=https://cloud.google.com/sdk/gcloud/#downloading_the_gcloud_command-line_tool>this doc for installation instructions</a>. If you already have <code>gcloud</code> installed, you can ensure it&rsquo;s up to date by running <code>gcloud components update</code>.</p><p>Note that this tutorial uses billable components of Google Cloud. Make sure you execute the <a href=#clean-up>clean up</a> steps after you finish.</p><h2 id=create-a-gke-cluster>Create a GKE Cluster</h2><p>Let&rsquo;s get started by creating a GKE cluster with Dataplane V2 enabled.</p><p>Let&rsquo;s set some defaults:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>gcp_project<span style=color:#f92672>=</span>your-project
</span></span><span style=display:flex><span>cluster_name<span style=color:#f92672>=</span>your-cluster
</span></span><span style=display:flex><span>cluster_region<span style=color:#f92672>=</span>us-east1
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>gcloud config set project $gcp_project
</span></span></code></pre></div><p>And create the cluster:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>gcloud container clusters create $cluster_name <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --enable-dataplane-v2 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --enable-ip-alias <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --release-channel regular <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --region $cluster_region
</span></span></code></pre></div><p>The current default version in the <code>regular</code> channel already enables the use of the Dataplane V2. If you want to know which versions are available in the release channels, you can execute:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># optional command to check versions in the channels, no need to run</span>
</span></span><span style=display:flex><span>gcloud container get-server-config --format <span style=color:#e6db74>&#34;yaml(channels)&#34;</span> --region $cluster_region
</span></span></code></pre></div><p>After the cluster is created your <code>kube-config</code> will be already pointing to the newly created cluster. If you need to reconnect to it, you can use the following command:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># optional command to re-configure the kube-config, no need to run</span>
</span></span><span style=display:flex><span>gcloud container clusters get-credentials $cluster_name --region $cluster_region
</span></span></code></pre></div><h2 id=deploy-a-demo-application>Deploy a Demo Application</h2><p>To check the Dataplane V2 feature, we want to use a non-trivial scenario. For this, we will deploy a <a href=https://github.com/GoogleCloudPlatform/microservices-demo>cloud-native microservices demo application</a> commonly used to demonstrate Kubernetes/GKE features.</p><p>Clone the GitHub repository:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>git clone https://github.com/GoogleCloudPlatform/microservices-demo
</span></span></code></pre></div><p>Apply the Kubernetes manifests:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f microservices-demo/release/kubernetes-manifests.yaml
</span></span></code></pre></div><p>Check that the pods are running:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get po
</span></span><span style=display:flex><span>NAME                                     READY   STATUS    RESTARTS   AGE
</span></span><span style=display:flex><span>adservice-5844cffbd4-k5nnq               1/1     Running   <span style=color:#ae81ff>0</span>          65s
</span></span><span style=display:flex><span>cartservice-fdc659ddc-lf8ph              1/1     Running   <span style=color:#ae81ff>0</span>          66s
</span></span><span style=display:flex><span>checkoutservice-64db75877d-stqwv         1/1     Running   <span style=color:#ae81ff>0</span>          68s
</span></span><span style=display:flex><span>currencyservice-9b7cdb45b-qsgzb          1/1     Running   <span style=color:#ae81ff>0</span>          66s
</span></span><span style=display:flex><span>emailservice-64d98b6f9d-s528z            1/1     Running   <span style=color:#ae81ff>0</span>          68s
</span></span><span style=display:flex><span>frontend-76ff9556-nsb6w                  1/1     Running   <span style=color:#ae81ff>0</span>          67s
</span></span><span style=display:flex><span>loadgenerator-589648f87f-nnfzt           1/1     Running   <span style=color:#ae81ff>0</span>          66s
</span></span><span style=display:flex><span>paymentservice-65bdf6757d-rqq8x          1/1     Running   <span style=color:#ae81ff>0</span>          67s
</span></span><span style=display:flex><span>productcatalogservice-5cd47f8cc8-d2x8d   1/1     Running   <span style=color:#ae81ff>0</span>          67s
</span></span><span style=display:flex><span>recommendationservice-b75687c5b-nz6rt    1/1     Running   <span style=color:#ae81ff>0</span>          68s
</span></span><span style=display:flex><span>redis-cart-74594bd569-wcvlz              1/1     Running   <span style=color:#ae81ff>0</span>          65s
</span></span><span style=display:flex><span>shippingservice-778554994-8l2pr          1/1     Running   <span style=color:#ae81ff>0</span>          66s
</span></span></code></pre></div><p>Check the external IP of the <code>LoadBalancer</code> service:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get svc frontend-external
</span></span><span style=display:flex><span>NAME                TYPE           CLUSTER-IP    EXTERNAL-IP      PORT<span style=color:#f92672>(</span>S<span style=color:#f92672>)</span>        AGE
</span></span><span style=display:flex><span>frontend-external   LoadBalancer   10.60.3.181   34.139.243.117   80:30595/TCP   2m1s
</span></span></code></pre></div><style type=text/css>.notice{padding:18px;line-height:24px;margin-bottom:24px;border-radius:4px;color:#444;background:#e7f2fa;text-align:left}.notice p:last-child{margin-bottom:0}.notice-title{margin:-18px -18px 12px;padding:4px 18px;border-radius:4px 4px 0 0;font-weight:700;color:#fff;background:#6ab0de;text-align:left}.notice.warning .notice-title{background:rgba(217,83,79,.9)}.notice.warning{background:#fae2e2}.notice.info .notice-title{background:#f0b37e}.notice.info{background:#fff2db}.notice.note .notice-title{background:#6ab0de}.notice.note{background:#e7f2fa}.notice.tip .notice-title{background:rgba(92,184,92,.8)}.notice.tip{background:#e6f9e6}.icon-notice{display:inline-flex;align-self:center;margin-right:8px}.icon-notice img,.icon-notice svg{height:1em;width:1em;fill:currentColor}.icon-notice img,.icon-notice.baseline svg{top:.125em;position:relative}</style><div><svg width="0" height="0" display="none" xmlns="http://www.w3.org/2000/svg"><symbol id="tip-notice" viewBox="0 0 512 512" preserveAspectRatio="xMidYMid meet"><path d="M504 256c0 136.967-111.033 248-248 248S8 392.967 8 256 119.033 8 256 8s248 111.033 248 248zM227.314 387.314l184-184c6.248-6.248 6.248-16.379.0-22.627l-22.627-22.627c-6.248-6.249-16.379-6.249-22.628.0L216 308.118l-70.059-70.059c-6.248-6.248-16.379-6.248-22.628.0l-22.627 22.627c-6.248 6.248-6.248 16.379.0 22.627l104 104c6.249 6.249 16.379 6.249 22.628.001z"/></symbol><symbol id="note-notice" viewBox="0 0 512 512" preserveAspectRatio="xMidYMid meet"><path d="M504 256c0 136.997-111.043 248-248 248S8 392.997 8 256C8 119.083 119.043 8 256 8s248 111.083 248 248zm-248 50c-25.405.0-46 20.595-46 46s20.595 46 46 46 46-20.595 46-46-20.595-46-46-46zm-43.673-165.346 7.418 136c.347 6.364 5.609 11.346 11.982 11.346h48.546c6.373.0 11.635-4.982 11.982-11.346l7.418-136c.375-6.874-5.098-12.654-11.982-12.654h-63.383c-6.884.0-12.356 5.78-11.981 12.654z"/></symbol><symbol id="warning-notice" viewBox="0 0 576 512" preserveAspectRatio="xMidYMid meet"><path d="M569.517 440.013C587.975 472.007 564.806 512 527.94 512H48.054c-36.937.0-59.999-40.055-41.577-71.987L246.423 23.985c18.467-32.009 64.72-31.951 83.154.0l239.94 416.028zM288 354c-25.405.0-46 20.595-46 46s20.595 46 46 46 46-20.595 46-46-20.595-46-46-46zm-43.673-165.346 7.418 136c.347 6.364 5.609 11.346 11.982 11.346h48.546c6.373.0 11.635-4.982 11.982-11.346l7.418-136c.375-6.874-5.098-12.654-11.982-12.654h-63.383c-6.884.0-12.356 5.78-11.981 12.654z"/></symbol><symbol id="info-notice" viewBox="0 0 512 512" preserveAspectRatio="xMidYMid meet"><path d="M256 8C119.043 8 8 119.083 8 256c0 136.997 111.043 248 248 248s248-111.003 248-248C504 119.083 392.957 8 256 8zm0 110c23.196.0 42 18.804 42 42s-18.804 42-42 42-42-18.804-42-42 18.804-42 42-42zm56 254c0 6.627-5.373 12-12 12h-88c-6.627.0-12-5.373-12-12v-24c0-6.627 5.373-12 12-12h12v-64h-12c-6.627.0-12-5.373-12-12v-24c0-6.627 5.373-12 12-12h64c6.627.0 12 5.373 12 12v1e2h12c6.627.0 12 5.373 12 12v24z"/></symbol></svg></div><div class="notice tip" id=optional-play-1><p class="first notice-title"><span class="icon-notice baseline"><svg><use href="#tip-notice"/></svg></span>Optional: Play around</p><p>Optionally, access the application from the browser using the external IP and add some products to the cart.</p></div><h2 id=undesired-network-access>Undesired Network Access</h2><p>This microservice application has quite a few components and, among them, we can see that the <code>CartService</code> communicates with the <code>Cache</code> (implemented by Redis) to store the product items in the user&rsquo;s shopping cart. See the <a href=https://github.com/GoogleCloudPlatform/microservices-demo#architecture>architecutre diagram</a> for details on how the components are related to each other.</p><p>List the Kubernetes services in the cluster to identify the Redis service:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get svc
</span></span><span style=display:flex><span>NAME                    TYPE           CLUSTER-IP     EXTERNAL-IP      PORT<span style=color:#f92672>(</span>S<span style=color:#f92672>)</span>        AGE
</span></span><span style=display:flex><span>adservice               ClusterIP      10.60.5.28     &lt;none&gt;           9555/TCP       6m
</span></span><span style=display:flex><span>cartservice             ClusterIP      10.60.6.160    &lt;none&gt;           7070/TCP       6m
</span></span><span style=display:flex><span>checkoutservice         ClusterIP      10.60.9.50     &lt;none&gt;           5050/TCP       6m
</span></span><span style=display:flex><span>currencyservice         ClusterIP      10.60.9.235    &lt;none&gt;           7000/TCP       6m
</span></span><span style=display:flex><span>emailservice            ClusterIP      10.60.8.126    &lt;none&gt;           5000/TCP       6m
</span></span><span style=display:flex><span>frontend                ClusterIP      10.60.1.70     &lt;none&gt;           80/TCP         6m
</span></span><span style=display:flex><span>frontend-external       LoadBalancer   10.60.3.181    34.139.243.117   80:30595/TCP   6m
</span></span><span style=display:flex><span>kubernetes              ClusterIP      10.60.0.1      &lt;none&gt;           443/TCP        17m
</span></span><span style=display:flex><span>paymentservice          ClusterIP      10.60.12.233   &lt;none&gt;           50051/TCP      6m
</span></span><span style=display:flex><span>productcatalogservice   ClusterIP      10.60.1.237    &lt;none&gt;           3550/TCP       6m
</span></span><span style=display:flex><span>recommendationservice   ClusterIP      10.60.6.61     &lt;none&gt;           8080/TCP       6m
</span></span><span style=display:flex><span>redis-cart              ClusterIP      10.60.1.152    &lt;none&gt;           6379/TCP       6m
</span></span><span style=display:flex><span>shippingservice         ClusterIP      10.60.4.213    &lt;none&gt;           50051/TCP      6m
</span></span></code></pre></div><p>You can see the <code>redis-cart</code> <code>ClusterIP</code> service configured on port <code>6379</code>. You can verify that this service is fronting the <code>redis-cart</code> Pod by describing and checking the <code>selector: app=redis-cart</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl describe svc redis-cart
</span></span><span style=display:flex><span>Name:              redis-cart
</span></span><span style=display:flex><span>Namespace:         default
</span></span><span style=display:flex><span>Labels:            &lt;none&gt;
</span></span><span style=display:flex><span>Annotations:       cloud.google.com/neg: <span style=color:#f92672>{</span><span style=color:#e6db74>&#34;ingress&#34;</span>:true<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>Selector:          app<span style=color:#f92672>=</span>redis-cart
</span></span><span style=display:flex><span>Type:              ClusterIP
</span></span><span style=display:flex><span>IP Families:       &lt;none&gt;
</span></span><span style=display:flex><span>IP:                10.60.1.152
</span></span><span style=display:flex><span>IPs:               10.60.1.152
</span></span><span style=display:flex><span>Port:              redis  6379/TCP
</span></span><span style=display:flex><span>TargetPort:        6379/TCP
</span></span><span style=display:flex><span>Endpoints:         10.56.8.4:6379
</span></span><span style=display:flex><span>Session Affinity:  None
</span></span><span style=display:flex><span>Events:            &lt;none&gt;
</span></span></code></pre></div><p>And confirm by checking the <code>redis-cart</code> deployment:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get deploy redis-cart -o json | jq .spec.template.metadata.labels
</span></span><span style=display:flex><span><span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;app&#34;</span>: <span style=color:#e6db74>&#34;redis-cart&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>Note that since describing a deployment is much more verbose than describing a service, we opted to use the <code>json</code> output piping to <code>jq</code>.</p><p>Let&rsquo;s play the role of a malicious actor that got access to a container in our cluster. For this, we will launch a container using the <code>redis</code> image and check connectivity to the <code>redis-cart</code> Pod.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl run rogue-1 --image<span style=color:#f92672>=</span>redis --restart<span style=color:#f92672>=</span>Never --rm -it -- /bin/bash
</span></span></code></pre></div><p>From the container&rsquo;s prompt run:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>root@rogue-1:/data# redis-cli -h redis-cart ping
</span></span><span style=display:flex><span>PONG
</span></span></code></pre></div><p>With this, we can confirm connectivity to the Redis database. A malicious actor can use different commands to access data or disrupt the service. Also, keep in mind that a malicious actor can explore this behavior across all application components. We are using the Redis database just as an example.</p><h2 id=kubernetes-network-policies>Kubernetes Network Policies</h2><p>To improve the security posture, the first thing that we&rsquo;ll do is create a <code>NetworkPolicy</code> that blocks this kind of undesired access, restricting ingress traffic to the <code>redis-cart</code> Pod only from the <code>CartService</code> Pods.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f- <span style=color:#e6db74>&lt;&lt; EOF
</span></span></span><span style=display:flex><span><span style=color:#e6db74>kind: NetworkPolicy
</span></span></span><span style=display:flex><span><span style=color:#e6db74>apiVersion: networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#e6db74>metadata:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  name: redis-cart-allow-from-cartservice
</span></span></span><span style=display:flex><span><span style=color:#e6db74>spec:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  policyTypes:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  - Ingress
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  podSelector:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    matchLabels:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      app: redis-cart
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  ingress:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  - from:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    - podSelector:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        matchLabels:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          app: cartservice
</span></span></span><span style=display:flex><span><span style=color:#e6db74>EOF</span>
</span></span></code></pre></div><p>The network policy is self-explanatory and you can see that we are using label selectors to match the Pods where we want the policy to be applied to and the pods where we want to enable ingress from.</p><p>Launch the rogue container again and try to execute the <code>ping</code> command and notice that it hangs:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl run rogue-1 --image<span style=color:#f92672>=</span>redis --restart<span style=color:#f92672>=</span>Never --rm -it -- /bin/bash
</span></span><span style=display:flex><span>root@rogue-1:/data# redis-cli -h redis-cart ping
</span></span></code></pre></div><p>Use <code>CTRL+C</code> to stop.</p><p>This feature is already helping to improve our security posture. However, depending on the level of access a malicious actor has gotten, they could notice that a network policy is in play and try a few tricks to bypass it.</p><div class="notice tip" id=optional-play-2><p class="first notice-title"><span class="icon-notice baseline"><svg><use href="#tip-notice"/></svg></span>Optional: Play around again</p><p>Access the application from the browser and add some products to the cart and check that the <code>CartService -> Cache</code> connectivity still works as expected.</p></div><p>We don&rsquo;t want a malicious user silently playing around in our cluster. So, besides preventing undesired access, we also want to log this activity. This log allows us to audit and alert on suspicious events.</p><h2 id=network-policy-logging>Network Policy Logging</h2><p>When you create a cluster with Dataplane V2 enabled, a default <code>NetworkLogging</code> object is created. We need to change this object to configure the network policy logging behavior.</p><p>Let&rsquo;s see how the default <code>NetworkLogging</code> object looks like initially:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get nl default -o yaml
</span></span><span style=display:flex><span>apiVersion: networking.gke.io/v1alpha1
</span></span><span style=display:flex><span>kind: NetworkLogging
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: default
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  cluster:
</span></span><span style=display:flex><span>    allow:
</span></span><span style=display:flex><span>      delegate: false
</span></span><span style=display:flex><span>      log: false
</span></span><span style=display:flex><span>    deny:
</span></span><span style=display:flex><span>      delegate: false
</span></span><span style=display:flex><span>      log: false
</span></span></code></pre></div><p>Use this yaml to change the default network logging configuration and enable logging for denied connections:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f- <span style=color:#e6db74>&lt;&lt; EOF
</span></span></span><span style=display:flex><span><span style=color:#e6db74>kind: NetworkLogging
</span></span></span><span style=display:flex><span><span style=color:#e6db74>apiVersion: networking.gke.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#e6db74>metadata:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  name: default
</span></span></span><span style=display:flex><span><span style=color:#e6db74>spec:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  cluster:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    allow:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      log: false
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      delegate: false
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    deny:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      log: true
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      delegate: false
</span></span></span><span style=display:flex><span><span style=color:#e6db74>EOF</span>
</span></span></code></pre></div><p>(You should expect to see a warning after applying this change, it&rsquo;s ok.)</p><p>Check the <a href=https://cloud.google.com/kubernetes-engine/docs/how-to/network-policy-logging>Network Policy Logging documentation</a> for a complete description of the <code>NetworkLogging</code> specification and configuration options.</p><p>Now we can check the <a href=https://cloud.google.com/logging/docs/quickstart-sdk>Google Cloud Logging</a> to verify the log events related to the network policy activity.</p><p>Execute the Redis <code>ping</code> command again:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl run rogue-1 --image<span style=color:#f92672>=</span>redis --restart<span style=color:#f92672>=</span>Never --rm -it -- /bin/bash
</span></span><span style=display:flex><span>root@rogue-1:/data# redis-cli -h redis-cart ping
</span></span></code></pre></div><p>And check the logs:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># replace &lt;your-cluster-name&gt; and &lt;your-project-name&gt;</span>
</span></span><span style=display:flex><span>gcloud logging read --project $gcp_project <span style=color:#e6db74>&#39;resource.type=&#34;k8s_node&#34; resource.labels.location=us-east1 resource.labels.cluster_name=&lt;your-cluster-name&gt; logName=&#34;projects/&lt;your-project-name&gt;/logs/policy-action&#34; jsonPayload.dest.pod_name=~&#34;redis-cart&#34; jsonPayload.disposition=&#34;deny&#34;&#39;</span>
</span></span></code></pre></div><p>You will see the log entries coming through with details about the events. Check the documentation for the <a href=https://cloud.google.com/kubernetes-engine/docs/how-to/network-policy-logging#log_format>Log Format definition</a>.</p><div class="notice note" id=cloud-logging><p class="first notice-title"><span class="icon-notice baseline"><svg><use href="#note-notice"/></svg></span>A note on Google Cloud Logging</p><p>You are able to check the logs with the previous command because <a href=https://cloud.google.com/logging/docs>Cloud Logging</a> is enabled by default in new clusters, and network policy logs are automatically shipped to Cloud Logging. See more about how to <a href=https://cloud.google.com/stackdriver/docs/solutions/gke/installing>configure Cloud Operations for GKE</a>.</p><p>Using Cloud Logging you can set up a <a href=https://cloud.google.com/logging/docs/logs-based-metrics>Log-based metric</a> and create an <a href=https://cloud.google.com/logging/docs/logs-based-metrics/charts-and-alerts#alert-on-lbm>alerting policy</a> upon suspicious activity.</p><p>Keep in mind that network policy logs generated on each cluster are available at <code>/var/log/network/policy_action.log*</code> and can be shipped to your preferred log aggregator.</p></div><h2 id=optional-delegating-network-policy-logging-configuration>Optional: Delegating Network Policy Logging Configuration</h2><p>Instead of enabling logging for all denied connections as we did with our previous <code>NetworkLogging</code> configuration, you can delegate it by using the annotation <code>policy.network.gke.io/enable-deny-logging: "true"</code>.</p><p>Update the <code>NetworkLogging</code> object:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f- <span style=color:#e6db74>&lt;&lt; EOF
</span></span></span><span style=display:flex><span><span style=color:#e6db74>kind: NetworkLogging
</span></span></span><span style=display:flex><span><span style=color:#e6db74>apiVersion: networking.gke.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#e6db74>metadata:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  name: default
</span></span></span><span style=display:flex><span><span style=color:#e6db74>spec:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  cluster:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    allow:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      log: false
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      delegate: false
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    deny:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      log: true
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      delegate: true
</span></span></span><span style=display:flex><span><span style=color:#e6db74>EOF</span>
</span></span></code></pre></div><p>Execute the Redis <code>ping</code> command again:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl run rogue-1 --image<span style=color:#f92672>=</span>redis --restart<span style=color:#f92672>=</span>Never --rm -it -- /bin/bash
</span></span><span style=display:flex><span>root@rogue-1:/data# redis-cli -h redis-cart ping
</span></span></code></pre></div><p>Check the logs and observe that there are no new entries:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># replace &lt;your-cluster-name&gt; and &lt;your-project-name&gt;</span>
</span></span><span style=display:flex><span>gcloud logging read --project $gcp_project <span style=color:#e6db74>&#39;resource.type=&#34;k8s_node&#34; resource.labels.location=us-east1 resource.labels.cluster_name=&lt;your-cluster-name&gt; logName=&#34;projects/&lt;your-project-name&gt;/logs/policy-action&#34; jsonPayload.dest.pod_name=~&#34;redis-cart&#34; jsonPayload.disposition=&#34;deny&#34;&#39;</span>
</span></span></code></pre></div><p>Annotate the namespace where the <code>redis-cart</code> (Pod where the connection was denied) is running with the following annotation:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl annotate namespaces default policy.network.gke.io/enable-deny-logging<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;true&#34;</span>
</span></span></code></pre></div><p>Execute the test again and observe that logs will show up.</p><div class="notice tip" id=allowed-connections-delegation><p class="first notice-title"><span class="icon-notice baseline"><svg><use href="#tip-notice"/></svg></span>Allowed connections delegation</p><p>Note that to delegate logging for <strong>allowed connections</strong>, the configuration is different. We have to add the annotation <code>policy.network.gke.io/enable-logging: "true"</code> to the <code>NetworkPolicy</code> instead of the namespace.</p></div><h2 id=clean-up>Clean up</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl delete -f microservices-demo/release/kubernetes-manifests.yaml
</span></span><span style=display:flex><span>gcloud container clusters delete $cluster_name --region $cluster_region
</span></span></code></pre></div></div><footer class=post__footer><div class="post__tags tags clearfix"><svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M32 19c0 1-1 2-1 2L21 31s-1 1-2 1-2-1-2-1L2 16c-1-1-1.4-2-1.4-2S0 12.5.0 11V3C0 1.5.8.8.8.8S1.5.0 3 0h8c1.5.0 3 .6 3 .6S15 1 16 2l15 15s1 1 1 2zM7 10a3 3 0 100-6 3 3 0 000 6z"/></svg><ul class=tags__list><li class=tags__item><a class="tags__link btn" href=/tags/devsecops/ rel=tag>devsecops</a></li><li class=tags__item><a class="tags__link btn" href=/tags/kubernetes/ rel=tag>kubernetes</a></li><li class=tags__item><a class="tags__link btn" href=/tags/gcp/ rel=tag>gcp</a></li><li class=tags__item><a class="tags__link btn" href=/tags/google-cloud/ rel=tag>google cloud</a></li><li class=tags__item><a class="tags__link btn" href=/tags/gke/ rel=tag>gke</a></li><li class=tags__item><a class="tags__link btn" href=/tags/dataplane-v2/ rel=tag>dataplane v2</a></li><li class=tags__item><a class="tags__link btn" href=/tags/network-policies/ rel=tag>network policies</a></li><li class=tags__item><a class="tags__link btn" href=/tags/cilium/ rel=tag>cilium</a></li></ul></div></footer></article></main></div></div><footer class=footer><div class="container footer__container flex"><div class=footer__copyright>&copy; 2022 Deployment - A tech blog focused on DevSecOps.
<span class=footer__copyright-credits>Generated with <a href=https://gohugo.io/ rel="nofollow noopener" target=_blank>Hugo</a> and <a href=https://github.com/Vimux/Mainroad/ rel="nofollow noopener" target=_blank>Mainroad</a> theme.</span></div></div></footer></div><script async defer src=/js/menu.js></script>
<script src=/js/custom.js></script></body></html>