<!doctype html><html class=no-js lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><title>Workload Identity in Practice - Deployment</title><script>(function(e,t){e[t]=e[t].replace("no-js","js")})(document.documentElement,"className")</script><meta name=description content="Workload Identity is the recommended way to access Google Cloud APIs from within GKE due to its improved security properties and manageability."><meta property="og:title" content="Workload Identity in Practice"><meta property="og:description" content="Workload Identity is the recommended way to access Google Cloud APIs from within GKE due to its improved security properties and manageability."><meta property="og:type" content="article"><meta property="og:url" content="https://deployment.properties/posts/devsecops/workload-identity-getting-started/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-06-15T00:00:00+00:00"><meta property="article:modified_time" content="2022-05-21T20:28:19-04:00"><meta itemprop=name content="Workload Identity in Practice"><meta itemprop=description content="Workload Identity is the recommended way to access Google Cloud APIs from within GKE due to its improved security properties and manageability."><meta itemprop=datePublished content="2020-06-15T00:00:00+00:00"><meta itemprop=dateModified content="2022-05-21T20:28:19-04:00"><meta itemprop=wordCount content="545"><meta itemprop=keywords content="devsecops,kubernetes,gcp,google cloud,gke,workload identity,"><meta name=twitter:card content="summary"><meta name=twitter:title content="Workload Identity in Practice"><meta name=twitter:description content="Workload Identity is the recommended way to access Google Cloud APIs from within GKE due to its improved security properties and manageability."><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=dns-prefetch href=//fonts.googleapis.com><link rel=dns-prefetch href=//fonts.gstatic.com><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700"><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=/css/custom.css><link rel="shortcut icon" href=/favicon.ico><script async src="https://www.googletagmanager.com/gtag/js?id=G-0BJEGTESYY"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-0BJEGTESYY",{anonymize_ip:!1})}</script></head><body class=body><div class="container container--outer"><header class=header><div class="container header__container"><div class=logo><a class=logo__link href=/ title=Deployment rel=home><div class="logo__item logo__text"><div class=logo__title>Deployment</div><div class=logo__tagline>Software Development, Security and Operations</div></div></a></div><nav class=menu><button class=menu__btn aria-haspopup=true aria-expanded=false tabindex=0>
<span class=menu__btn-title tabindex=-1>Menu</span></button><ul class=menu__list><li class=menu__item><a class=menu__link href=/about/><span class=menu__text>about</span></a></li><li class=menu__item><a class=menu__link href=/posts/devsecops/kubernetes-security/><span class=menu__text>Kubernetes Security</span></a></li><li class=menu__item><a class=menu__link href=/tags/><span class=menu__text>tags</span></a></li></ul></nav></div></header><div class="wrapper flex"><div class=primary><main class=main role=main><article class=post><header class=post__header><h1 class=post__title>Workload Identity in Practice</h1><div class="post__meta meta"><div class="meta__item-author meta__item"><svg class="meta__icon icon icon-author" width="16" height="16" viewBox="0 0 12 16"><path d="M6 1c2.2.0 3.5 2 3.5 4.5C9.5 7 8.9 8.2 8 9c2.9.8 4 2.5 4 5v1H0v-1c0-2.5 1.1-4.2 4-5-.9-.8-1.5-2-1.5-3.5C2.5 3 3.8 1 6 1z"/></svg><span class=meta__text>Romulo Santos</span></div><div class="meta__item-datetime meta__item"><svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0C7 0 1 6 1 14s6 14 14 14 14-6 14-14S23 0 15 0zm0 25C9 25 4 20 4 14S9 3 15 3s11 5 11 11-5 11-11 11zm1-18h-2v8.4l6.8 4.4L22 18l-6-3.8V7z"/></svg><time class=meta__text datetime=2020-06-15T00:00:00Z>2020-06-15</time>
<time class=meta__text datetime=2022-05-21T20:28:19-04:00>(Last Modified: 2022-05-21)</time></div></div></header><div class="content post__content clearfix"><p>In this tutorial, we&rsquo;re going to go through the <a href=https://cloud.google.com/blog/products/containers-kubernetes/introducing-workload-identity-better-authentication-for-your-gke-applications>Workload Identity</a> feature and see how it helps to improve the way we manage access to Google Services and APIs from applications running in <a href=https://cloud.google.com/kubernetes-engine>Google Kubernetes Engine (GKE)</a>.</p><p>Workload Identity is the recommended way to access Google Cloud APIs from within GKE due to its improved security properties and manageability. With Workload Identity you can control access to APIs using <a href=https://cloud.google.com/iam/docs/service-accounts>Google service accounts</a> and <a href=https://cloud.google.com/iam/docs/understanding-roles>IAM roles</a> without deploying static service account JSON keys to Pods and without relying on the node&rsquo;s service account.</p><h2 id=create-a-gke-cluster>Create a GKE Cluster</h2><p>Let&rsquo;s get started.</p><p>Assuming you already have a GCP project, create a variable with the name of your project and two other variables for cluster name and region.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>gcp_project<span style=color:#f92672>=</span>my-project
</span></span><span style=display:flex><span>cluster_name<span style=color:#f92672>=</span>le-cluster
</span></span><span style=display:flex><span>cluster_region<span style=color:#f92672>=</span>us-east1
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>gcloud config set project $gcp_project
</span></span></code></pre></div><p>Start creating a simple cluster with Workload Identity enabled, which is defined with the property <code>--workload-pool</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>gcloud beta container clusters create <span style=color:#e6db74>${</span>cluster_name<span style=color:#e6db74>}</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --release-channel regular <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --enable-ip-alias <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --region $cluster_region <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --workload-pool<span style=color:#f92672>=</span><span style=color:#e6db74>${</span>gcp_project<span style=color:#e6db74>}</span>.svc.id.goog
</span></span></code></pre></div><p>Get cluster credentials:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>gcloud container clusters get-credentials $cluster_name --region $cluster_region
</span></span></code></pre></div><h2 id=configure-workload-identity>Configure Workload Identity</h2><p>With Workload Identity, you configure a Kubernetes service account (KSA) to act as a Google service account (GSA). Any workload running as the KSA, automatically authenticates as the GSA when accessing Google Cloud APIs.</p><p>Let&rsquo;s create a Google Service Account:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>gcloud iam service-accounts create le-application-stg
</span></span></code></pre></div><p>Now we create a k8s namespace and k8s service account:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl create namespace staging
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>kubectl create serviceaccount le-application -n staging
</span></span></code></pre></div><style type=text/css>.notice{padding:18px;line-height:24px;margin-bottom:24px;border-radius:4px;color:#444;background:#e7f2fa;text-align:left}.notice p:last-child{margin-bottom:0}.notice-title{margin:-18px -18px 12px;padding:4px 18px;border-radius:4px 4px 0 0;font-weight:700;color:#fff;background:#6ab0de;text-align:left}.notice.warning .notice-title{background:rgba(217,83,79,.9)}.notice.warning{background:#fae2e2}.notice.info .notice-title{background:#f0b37e}.notice.info{background:#fff2db}.notice.note .notice-title{background:#6ab0de}.notice.note{background:#e7f2fa}.notice.tip .notice-title{background:rgba(92,184,92,.8)}.notice.tip{background:#e6f9e6}.icon-notice{display:inline-flex;align-self:center;margin-right:8px}.icon-notice img,.icon-notice svg{height:1em;width:1em;fill:currentColor}.icon-notice img,.icon-notice.baseline svg{top:.125em;position:relative}</style><div><svg width="0" height="0" display="none" xmlns="http://www.w3.org/2000/svg"><symbol id="tip-notice" viewBox="0 0 512 512" preserveAspectRatio="xMidYMid meet"><path d="M504 256c0 136.967-111.033 248-248 248S8 392.967 8 256 119.033 8 256 8s248 111.033 248 248zM227.314 387.314l184-184c6.248-6.248 6.248-16.379.0-22.627l-22.627-22.627c-6.248-6.249-16.379-6.249-22.628.0L216 308.118l-70.059-70.059c-6.248-6.248-16.379-6.248-22.628.0l-22.627 22.627c-6.248 6.248-6.248 16.379.0 22.627l104 104c6.249 6.249 16.379 6.249 22.628.001z"/></symbol><symbol id="note-notice" viewBox="0 0 512 512" preserveAspectRatio="xMidYMid meet"><path d="M504 256c0 136.997-111.043 248-248 248S8 392.997 8 256C8 119.083 119.043 8 256 8s248 111.083 248 248zm-248 50c-25.405.0-46 20.595-46 46s20.595 46 46 46 46-20.595 46-46-20.595-46-46-46zm-43.673-165.346 7.418 136c.347 6.364 5.609 11.346 11.982 11.346h48.546c6.373.0 11.635-4.982 11.982-11.346l7.418-136c.375-6.874-5.098-12.654-11.982-12.654h-63.383c-6.884.0-12.356 5.78-11.981 12.654z"/></symbol><symbol id="warning-notice" viewBox="0 0 576 512" preserveAspectRatio="xMidYMid meet"><path d="M569.517 440.013C587.975 472.007 564.806 512 527.94 512H48.054c-36.937.0-59.999-40.055-41.577-71.987L246.423 23.985c18.467-32.009 64.72-31.951 83.154.0l239.94 416.028zM288 354c-25.405.0-46 20.595-46 46s20.595 46 46 46 46-20.595 46-46-20.595-46-46-46zm-43.673-165.346 7.418 136c.347 6.364 5.609 11.346 11.982 11.346h48.546c6.373.0 11.635-4.982 11.982-11.346l7.418-136c.375-6.874-5.098-12.654-11.982-12.654h-63.383c-6.884.0-12.356 5.78-11.981 12.654z"/></symbol><symbol id="info-notice" viewBox="0 0 512 512" preserveAspectRatio="xMidYMid meet"><path d="M256 8C119.043 8 8 119.083 8 256c0 136.997 111.043 248 248 248s248-111.003 248-248C504 119.083 392.957 8 256 8zm0 110c23.196.0 42 18.804 42 42s-18.804 42-42 42-42-18.804-42-42 18.804-42 42-42zm56 254c0 6.627-5.373 12-12 12h-88c-6.627.0-12-5.373-12-12v-24c0-6.627 5.373-12 12-12h12v-64h-12c-6.627.0-12-5.373-12-12v-24c0-6.627 5.373-12 12-12h64c6.627.0 12 5.373 12 12v1e2h12c6.627.0 12 5.373 12 12v24z"/></symbol></svg></div><div class="notice note" id=note-k8s-declarative-config><p class="first notice-title"><span class="icon-notice baseline"><svg><use href="#note-notice"/></svg></span>A note on Kubernetes Declarative Configuration</p><p>In this tutorial, we are using the <code>kubectl</code> CLI to create and annotate the namespace and service account, and to run Pods. The purpose is to play around and quickly evaluate how Workload Identity works. In the real world you&rsquo;ll likely want to use YAML configuration to declaratively manage your Kubernetes resources.</p></div><p>Associate both SAs using an <a href=https://cloud.google.com/sdk/gcloud/reference/iam/service-accounts/add-iam-policy-binding>IAM Policy binding</a>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>gcloud iam service-accounts add-iam-policy-binding <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --role roles/iam.workloadIdentityUser <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --member <span style=color:#e6db74>&#34;serviceAccount:</span><span style=color:#e6db74>${</span>gcp_project<span style=color:#e6db74>}</span><span style=color:#e6db74>.svc.id.goog[staging/le-application]&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  le-application-stg@<span style=color:#e6db74>${</span>gcp_project<span style=color:#e6db74>}</span>.iam.gserviceaccount.com
</span></span></code></pre></div><p>And, finally, annotate your service account:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl annotate serviceaccount <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  le-application <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  iam.gke.io/gcp-service-account<span style=color:#f92672>=</span>le-application-stg@<span style=color:#e6db74>${</span>gcp_project<span style=color:#e6db74>}</span>.iam.gserviceaccount.com <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -n staging
</span></span></code></pre></div><h2 id=validate-the-config>Validate the config</h2><p>The workload identity configuration is in place and we are ready to use it. First, we&rsquo;ll create a Google Cloud Storage (GCS) bucket and upload a file.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>gsutil mb -p $gcp_project gs://le-application-stg/
</span></span><span style=display:flex><span>echo foo &gt; my_application_file
</span></span><span style=display:flex><span>gsutil cp my_application_file gs://le-application-stg/
</span></span></code></pre></div><p>Now let&rsquo;s run a Pod and try to download the file from the GCS bucket just created:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl run -it --rm --restart<span style=color:#f92672>=</span>Never <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --serviceaccount le-application <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --image google/cloud-sdk:slim bb8 -n staging
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>root@bb8:/ gsutil cp gs://le-application-stg/my_application_file .
</span></span><span style=display:flex><span>AccessDeniedException: <span style=color:#ae81ff>403</span> le-application-stg@my-project.iam.gserviceaccount.com does not have storage.objects.list access to the Google Cloud Storage bucket.
</span></span></code></pre></div><p>It fails. To fix it we grant the GSA access to the bucket:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>gsutil iam ch serviceAccount:le-application-stg@<span style=color:#e6db74>${</span>gcp_project<span style=color:#e6db74>}</span>.iam.gserviceaccount.com:objectViewer gs://le-application-stg/
</span></span></code></pre></div><p>From now on, we manage access to services and APIs using the GSA and Google IAM and in Kubernetes we grant access to applications using the KSA.</p><p>Run again and verify:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl run -it --rm --image google/cloud-sdk:slim bb8 --serviceaccount le-application -n staging --restart<span style=color:#f92672>=</span>Never
</span></span><span style=display:flex><span>root@bb8:/ gsutil cp gs://le-application-stg/my_application_file .
</span></span><span style=display:flex><span>root@bb8:/ cat my_application_file
</span></span></code></pre></div><h2 id=clean-up>Clean up</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>gsutil rm -r gs://le-application-stg
</span></span><span style=display:flex><span>gcloud iam service-accounts delete le-application-stg@<span style=color:#e6db74>${</span>gcp_project<span style=color:#e6db74>}</span>.iam.gserviceaccount.com
</span></span><span style=display:flex><span>gcloud container clusters delete $cluster_name --region $cluster_region
</span></span></code></pre></div><h2 id=next-steps>Next Steps</h2><p>If you liked this content you might be interested to check my tutorial <a href=https://cloud.google.com/community/tutorials/restrict-workload-identity-with-kyverno>Restrict Google Kubernetes Engine Workload Identity with Kyverno</a> on the Google Cloud Community tutorials.</p></div><footer class=post__footer><div class="post__tags tags clearfix"><svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M32 19c0 1-1 2-1 2L21 31s-1 1-2 1-2-1-2-1L2 16c-1-1-1.4-2-1.4-2S0 12.5.0 11V3C0 1.5.8.8.8.8S1.5.0 3 0h8c1.5.0 3 .6 3 .6S15 1 16 2l15 15s1 1 1 2zM7 10a3 3 0 100-6 3 3 0 000 6z"/></svg><ul class=tags__list><li class=tags__item><a class="tags__link btn" href=/tags/devsecops/ rel=tag>devsecops</a></li><li class=tags__item><a class="tags__link btn" href=/tags/kubernetes/ rel=tag>kubernetes</a></li><li class=tags__item><a class="tags__link btn" href=/tags/gcp/ rel=tag>gcp</a></li><li class=tags__item><a class="tags__link btn" href=/tags/google-cloud/ rel=tag>google cloud</a></li><li class=tags__item><a class="tags__link btn" href=/tags/gke/ rel=tag>gke</a></li><li class=tags__item><a class="tags__link btn" href=/tags/workload-identity/ rel=tag>workload identity</a></li></ul></div></footer></article></main></div></div><footer class=footer><div class="container footer__container flex"><div class=footer__copyright>&copy; 2023 Deployment - Software Development, Security and Operations.
<span class=footer__copyright-credits>Generated with <a href=https://gohugo.io/ rel="nofollow noopener" target=_blank>Hugo</a> and <a href=https://github.com/Vimux/Mainroad/ rel="nofollow noopener" target=_blank>Mainroad</a> theme.</span></div></div></footer></div><script async defer src=/js/menu.js></script>
<script src=/js/custom.js></script></body></html>