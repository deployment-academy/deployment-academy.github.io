<!doctype html><html class=no-js lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><title>HashiCorp Vault AWS Auth with Amazon EKS and IAM Roles for Service Accounts - Deployment</title><script>(function(e,t){e[t]=e[t].replace("no-js","js")})(document.documentElement,"className")</script><meta name=description content="Configure and explore the HashiCorp Vault AWS Auth method with Amazon EKS"><meta property="og:title" content="HashiCorp Vault AWS Auth with Amazon EKS and IAM Roles for Service Accounts"><meta property="og:description" content="Configure and explore the HashiCorp Vault AWS Auth method with Amazon EKS"><meta property="og:type" content="article"><meta property="og:url" content="https://deployment.properties/posts/devsecops/vault-eks-irsa/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-05-23T00:00:00+00:00"><meta property="article:modified_time" content="2022-05-21T20:28:19-04:00"><meta itemprop=name content="HashiCorp Vault AWS Auth with Amazon EKS and IAM Roles for Service Accounts"><meta itemprop=description content="Configure and explore the HashiCorp Vault AWS Auth method with Amazon EKS"><meta itemprop=datePublished content="2021-05-23T00:00:00+00:00"><meta itemprop=dateModified content="2022-05-21T20:28:19-04:00"><meta itemprop=wordCount content="1957"><meta itemprop=keywords content="devsecops,kubernetes,aws,eks,vault,"><meta name=twitter:card content="summary"><meta name=twitter:title content="HashiCorp Vault AWS Auth with Amazon EKS and IAM Roles for Service Accounts"><meta name=twitter:description content="Configure and explore the HashiCorp Vault AWS Auth method with Amazon EKS"><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=dns-prefetch href=//fonts.googleapis.com><link rel=dns-prefetch href=//fonts.gstatic.com><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700"><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=/css/custom.css><link rel="shortcut icon" href=/favicon.ico><script async src="https://www.googletagmanager.com/gtag/js?id=G-0BJEGTESYY"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-0BJEGTESYY",{anonymize_ip:!1})}</script></head><body class=body><div class="container container--outer"><header class=header><div class="container header__container"><div class=logo><a class=logo__link href=/ title=Deployment rel=home><div class="logo__item logo__text"><div class=logo__title>Deployment</div><div class=logo__tagline>Software Development, Security and Operations</div></div></a></div><nav class=menu><button class=menu__btn aria-haspopup=true aria-expanded=false tabindex=0>
<span class=menu__btn-title tabindex=-1>Menu</span></button><ul class=menu__list><li class=menu__item><a class=menu__link href=/about/><span class=menu__text>about</span></a></li><li class=menu__item><a class=menu__link href=/posts/devsecops/kubernetes-security/><span class=menu__text>Kubernetes Security</span></a></li><li class=menu__item><a class=menu__link href=/tags/><span class=menu__text>tags</span></a></li></ul></nav></div></header><div class="wrapper flex"><div class=primary><main class=main role=main><article class=post><header class=post__header><h1 class=post__title>HashiCorp Vault AWS Auth with Amazon EKS and IAM Roles for Service Accounts</h1><div class="post__meta meta"><div class="meta__item-author meta__item"><svg class="meta__icon icon icon-author" width="16" height="16" viewBox="0 0 12 16"><path d="M6 1c2.2.0 3.5 2 3.5 4.5C9.5 7 8.9 8.2 8 9c2.9.8 4 2.5 4 5v1H0v-1c0-2.5 1.1-4.2 4-5-.9-.8-1.5-2-1.5-3.5C2.5 3 3.8 1 6 1z"/></svg><span class=meta__text>Romulo Santos</span></div><div class="meta__item-datetime meta__item"><svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0C7 0 1 6 1 14s6 14 14 14 14-6 14-14S23 0 15 0zm0 25C9 25 4 20 4 14S9 3 15 3s11 5 11 11-5 11-11 11zm1-18h-2v8.4l6.8 4.4L22 18l-6-3.8V7z"/></svg><time class=meta__text datetime=2021-05-23T00:00:00Z>2021-05-23</time>
<time class=meta__text datetime=2022-05-21T20:28:19-04:00>(Last Modified: 2022-05-21)</time></div></div></header><div class="content post__content clearfix"><p>In this tutorial, we are going to configure and explore the <a href=https://www.vaultproject.io/docs/auth/aws>HashiCorp Vault AWS Auth method</a> with <a href=https://aws.amazon.com/eks>Amazon EKS</a>. We will start performing the Vault authentication using the EC2 instances (Kubernetes nodes) identity and later we will use a Kubernetes service account to impersonate an AWS IAM Role and have more fine-grained control at the Pod level.</p><p>Before you begin, notice that this is a hands-on tutorial that focuses on configuring and playing around with the features. To learn more about HashiCorp Vault, Amazon EKS, or IAM Roles for Service Accounts, please, refer to the documentation linked in the text.</p><h2 id=context>Context</h2><p>Using the Vault AWS Auth method with <a href=https://aws.amazon.com/blogs/opensource/introducing-fine-grained-iam-roles-service-accounts/>IAM Roles for Service Accounts</a> allows you to read secrets from Vault using a token served based on a trust relationship with your workload identify (kubernetes namespace and service account) running on EKS. The clear benefit with this approach is that you don&rsquo;t need to deploy static credentials along with your applications such as a token or user password.</p><h2 id=prerequisites>Prerequisites</h2><p>To execute this tutorial you need:</p><ul><li>An AWS Account</li><li>Local environment configured with AWS credentials with the required IAM permissions to manage EKS and IAM resources</li><li>Necessary CLI tools installed (awscli, eksctl and kubectl).</li></ul><p>Check the <a href=https://docs.aws.amazon.com/eks/latest/userguide/getting-started-eksctl.html#eksctl-prereqs>Getting started with Amazon EKS – eksctl Prerequisites</a> section if you need help.</p><h2 id=create-the-eks-cluster>Create the EKS cluster</h2><p>We will start creating a simple EKS cluster with a managed Linux node group. See the <a href=https://docs.aws.amazon.com/eks/latest/userguide/getting-started-eksctl.html>Getting started with Amazon EKS – eksctl</a> for more details.</p><p>Declare some variables that we&rsquo;ll use throughout the tutorial.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>CLUSTER_NAME<span style=color:#f92672>=</span>le-cluster
</span></span><span style=display:flex><span>ACCOUNT_ID<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>aws sts get-caller-identity --query <span style=color:#e6db74>&#34;Account&#34;</span> --output text<span style=color:#66d9ef>)</span>
</span></span></code></pre></div><p>Create the cluster.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>eksctl create cluster --name $CLUSTER_NAME <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --with-oidc --managed
</span></span><span style=display:flex><span><span style=color:#75715e># output omitted</span>
</span></span></code></pre></div><p>This is going to take several minutes. When the cluster is ready your <code>kubectl</code> will have access configured to the newly created cluster.</p><p>Check the access to the cluster.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get nodes
</span></span><span style=display:flex><span><span style=color:#75715e># output omitted</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>kubectl get po -A
</span></span><span style=display:flex><span><span style=color:#75715e># output omitted</span>
</span></span></code></pre></div><p>Check the caller identity of a Pod running in the cluster.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl run awscli -it --rm --restart<span style=color:#f92672>=</span>Never <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --image amazon/aws-cli sts get-caller-identity
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>If you don<span style=color:#960050;background-color:#1e0010>&#39;</span>t see a command prompt, try pressing enter.
</span></span><span style=display:flex><span><span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;UserId&#34;</span>: <span style=color:#e6db74>&#34;AROA000000425TR6IXYLJ:i-065600000008806af&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;Account&#34;</span>: <span style=color:#e6db74>&#34;123456789012&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;Arn&#34;</span>: <span style=color:#e6db74>&#34;arn:aws:sts::123456789012:assumed-role/eksctl-le-cluster-nodegroup-ng-b0-NodeInstanceRole-146NXG82R7UOU/i-065600000008806af&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>pod <span style=color:#e6db74>&#34;awscli&#34;</span> deleted
</span></span></code></pre></div><p>Note that the ARN in the output is the Node IAM Role ARN of the Node Group configuration created in the <code>eksctl create cluster</code> command. By default, all pods running on the Kubernetes node will assume the same role and share the same set of permissions.</p><h2 id=configure-the-vault-aws-auth-method>Configure the Vault AWS Auth method</h2><p>The AWS auth method provides an automated mechanism to retrieve a Vault token for IAM principals and AWS EC2 instances. In other words, a client running on AWS will use the instance identity, usually through the <a href=https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/instancedata-data-retrieval.html>metadata service</a>, to communicate with Vault and retrieve a token. Check the <a href=https://www.vaultproject.io/docs/auth/aws>Vault AWS Auth docs</a> for a more detailed explanation of the authentication workflow and different options.</p><p>The first step to configure the AWS authentication method in Vault is to provide AWS credentials to Vault. So, before we start the Vault server, let&rsquo;s create a policy and a user in AWS for Vault.</p><p>Create the AWS policy.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>
</span></span><span style=display:flex><span>VAULT_AUTH_POLICY_NAME<span style=color:#f92672>=</span>vault-auth-policy
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>cat <span style=color:#e6db74>&lt;&lt;EOF &gt; $VAULT_AUTH_POLICY_NAME.json
</span></span></span><span style=display:flex><span><span style=color:#e6db74>{
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;Version&#34;: &#34;2012-10-17&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;Statement&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            &#34;Sid&#34;: &#34;&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            &#34;Effect&#34;: &#34;Allow&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            &#34;Action&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                &#34;iam:GetUser&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                &#34;iam:GetRole&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                &#34;iam:GetInstanceProfile&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                &#34;ec2:DescribeInstances&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            ],
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            &#34;Resource&#34;: &#34;*&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    ]
</span></span></span><span style=display:flex><span><span style=color:#e6db74>}
</span></span></span><span style=display:flex><span><span style=color:#e6db74>EOF</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>VAULT_AUTH_POLICY_ARN<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>aws iam create-policy <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --policy-name $VAULT_AUTH_POLICY_NAME <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --description <span style=color:#e6db74>&#34;Policy used by the Vault user to check instance identity&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --policy-document file://$VAULT_AUTH_POLICY_NAME.json | jq -r .Policy.Arn<span style=color:#66d9ef>)</span>
</span></span></code></pre></div><p>This policy is a simplified version of the <a href=https://www.vaultproject.io/docs/auth/aws#recommended-vault-iam-policy>recommended Vault IAM policy</a> from the docs.</p><p>Create the AWS user and credentials.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>VAULT_AUTH_USER_NAME<span style=color:#f92672>=</span>vault-auth
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>aws iam create-user --user-name $VAULT_AUTH_USER_NAME
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>aws iam attach-user-policy --user-name $VAULT_AUTH_USER_NAME --policy-arn $VAULT_AUTH_POLICY_ARN
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>aws iam create-access-key --user-name $VAULT_AUTH_USER_NAME &gt; access_key.json
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># output omitted</span>
</span></span></code></pre></div><p>Now we are ready to start Vault and configure the auth method.</p><p>For the purpose of this tutorial, we&rsquo;ll run Vault locally in dev mode and make it reachable from AWS using <a href=https://ngrok.com/download>ngrok</a>.</p><p>Open a different terminal session and start the Vault server using Docker. We will keep this session running during the entire tutorial.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>docker run --cap-add<span style=color:#f92672>=</span>IPC_LOCK --rm -it <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -p 8200:8200 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -e VAULT_DEV_ROOT_TOKEN_ID<span style=color:#f92672>=</span>mytoken <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>vault
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># output omitted</span>
</span></span></code></pre></div><p>Open another terminal session. Make sure you are in the same folder we started the tutorial since we are going to use the <code>access_key.json</code> file created before. We will use this container to execute the Vault client commands.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>docker run --rm -it <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -e VAULT_ADDR<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;http://localhost:8200&#39;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -e VAULT_TOKEN<span style=color:#f92672>=</span>mytoken <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -e VAULT_AUTH_ACCESS_KEY_ID<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>jq -r .AccessKey.AccessKeyId &lt; access_key.json<span style=color:#66d9ef>)</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -e VAULT_AUTH_SECRET_ACCESS_KEY<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>jq -r .AccessKey.SecretAccessKey &lt; access_key.json<span style=color:#66d9ef>)</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --net<span style=color:#f92672>=</span>host vault /bin/sh
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span><span style=color:#75715e># output omitted</span>
</span></span></code></pre></div><p>The following commands will run from inside the container. Notice in the command above that, for convenience, we are exporting the secret and access key to the container environment. It&rsquo;s just a convenience so we don&rsquo;t need to copy and paste this data.</p><p>Enable and configure the AWS auth method.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>vault auth enable aws
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>vault write auth/aws/config/client <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    secret_key<span style=color:#f92672>=</span>$VAULT_AUTH_SECRET_ACCESS_KEY <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    access_key<span style=color:#f92672>=</span>$VAULT_AUTH_ACCESS_KEY_ID
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># output omitted</span>
</span></span></code></pre></div><h2 id=optional-authenticate-using-the-node-iam-role>Optional: Authenticate using the Node IAM Role</h2><p>Still from inside the container, we are going to create a Vault role and bind the EC2 data.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>vault write auth/aws/role/dev-role-iam auth_type<span style=color:#f92672>=</span>iam <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    inferred_entity_type<span style=color:#f92672>=</span>ec2_instance <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    inferred_aws_region<span style=color:#f92672>=</span>us-east-1 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    bound_account_id<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;123456789012&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    bound_iam_instance_profile_arn<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;arn:aws:iam::123456789012:instance-profile/eks1-*&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    policies<span style=color:#f92672>=</span>dev <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    max_ttl<span style=color:#f92672>=</span>768h
</span></span></code></pre></div><p>The instance profile ARN provided in the <code>bound_iam_instance_profile_arn</code> field is from the Node IAM Role and identifies the EC2 instances of the Node group. We can verify this instance profile ARN with the following command.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>aws ec2 describe-instances <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --filters Name<span style=color:#f92672>=</span>tag:<span style=color:#e6db74>&#34;eks:cluster-name&#34;</span>,Values<span style=color:#f92672>=</span>$CLUSTER_NAME <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --query <span style=color:#e6db74>&#39;Reservations[0].Instances[0].IamInstanceProfile.Arn&#39;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --output text
</span></span></code></pre></div><p>Note that you need to fill the other values for <code>inferred_aws_region</code> and <code>bound_account_id</code> in the Vault role with your own. Also, note that the Vault policy <code>dev</code> used in the role does not exist in this Vault instance, it&rsquo;s just to illustrate.</p><p>Start ngrok in a different terminal session.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>./ngrok http <span style=color:#ae81ff>8200</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Session Status                online
</span></span><span style=display:flex><span>Session Expires               <span style=color:#ae81ff>1</span> hour, <span style=color:#ae81ff>59</span> minutes
</span></span><span style=display:flex><span>Version                       2.3.40
</span></span><span style=display:flex><span>Region                        Mars <span style=color:#f92672>(</span>mars<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>Web Interface                 http://127.0.0.1:4040
</span></span><span style=display:flex><span>Forwarding                    http://2a7f0319443a.ngrok.io -&gt; http://localhost:8200
</span></span><span style=display:flex><span>Forwarding                    https://2a7f0319443a.ngrok.io -&gt; http://localhost:8200
</span></span></code></pre></div><p>Perform the Vault login from a pod running in EKS (make sure you use the ngrok address as the Vault address).</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl run vault -it --rm --restart<span style=color:#f92672>=</span>Never --image vault -- <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    vault login -address<span style=color:#f92672>=</span>http://2a7f0319443a.ngrok.io <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -method<span style=color:#f92672>=</span>aws <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    role<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;dev-role-iam&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>...<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>Success! You are now authenticated. The token information displayed below
</span></span><span style=display:flex><span>is already stored in the token helper. You <span style=color:#66d9ef>do</span> NOT need to run <span style=color:#e6db74>&#34;vault login&#34;</span>
</span></span><span style=display:flex><span>again. Future Vault requests will automatically use this token.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Key                      Value
</span></span><span style=display:flex><span>---                      -----
</span></span><span style=display:flex><span>token                    s.A4HmMdld2oOdRdewylaj6qLy
</span></span><span style=display:flex><span>token_accessor           QaNhxJxywmUasNFMmihdgoBB
</span></span><span style=display:flex><span>token_duration           768h
</span></span><span style=display:flex><span>token_renewable          true
</span></span><span style=display:flex><span>token_policies           <span style=color:#f92672>[</span><span style=color:#e6db74>&#34;default&#34;</span> <span style=color:#e6db74>&#34;dev&#34;</span><span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>identity_policies        <span style=color:#f92672>[]</span>
</span></span><span style=display:flex><span>policies                 <span style=color:#f92672>[</span><span style=color:#e6db74>&#34;default&#34;</span> <span style=color:#e6db74>&#34;dev&#34;</span><span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>token_meta_account_id    <span style=color:#ae81ff>123456789012</span>
</span></span><span style=display:flex><span>token_meta_auth_type     iam
</span></span><span style=display:flex><span>token_meta_role_id       231bdbec-7246-6c24-e255-b1065e2eaa74
</span></span><span style=display:flex><span>pod <span style=color:#e6db74>&#34;vault&#34;</span> deleted
</span></span></code></pre></div><p>You should see an output with the Vault token.</p><h2 id=configure-the-aws-iam-roles-for-service-accounts>Configure the AWS IAM Roles for Service Accounts</h2><p>Now let&rsquo;s get to the AWS IAM Roles for Service Accounts configuration. Please, note that I&rsquo;ll configure the AWS IAM resources and k8s service account individually so we can have a better understanding of what is happening behind the scenes. But the eksctl has a command <code>eksctl create iamserviceaccount</code> that simplifies the following steps to a single command.</p><p>Get the OIDC provider identifier for your cluster. This is available because we used the <code>--with-oidc</code> flag when creating the cluster, otherwise we&rsquo;d need to create the OIDC provider and associate to the cluster (<a href=https://docs.aws.amazon.com/eks/latest/userguide/enable-iam-roles-for-service-accounts.html>more about this here</a>).</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>OIDC_PROVIDER<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>aws eks describe-cluster --name $CLUSTER_NAME <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --query <span style=color:#e6db74>&#34;cluster.identity.oidc.issuer&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --output text | sed -e <span style=color:#e6db74>&#34;s/^https:\/\///&#34;</span><span style=color:#66d9ef>)</span>
</span></span></code></pre></div><p>Create the trust policy and an IAM Role to be used by the Vault authentication.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>VAULT_AUTH_ROLE_NAME<span style=color:#f92672>=</span>vault-auth
</span></span><span style=display:flex><span>VAULT_AUTH_K8S_SERVICE_ACCOUNT<span style=color:#f92672>=</span>$VAULT_AUTH_ROLE_NAME
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>cat <span style=color:#e6db74>&lt;&lt;EOF &gt; ${VAULT_AUTH_ROLE_NAME}.trust.json
</span></span></span><span style=display:flex><span><span style=color:#e6db74>{
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &#34;Version&#34;: &#34;2012-10-17&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &#34;Statement&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      &#34;Effect&#34;: &#34;Allow&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      &#34;Principal&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        &#34;Federated&#34;: &#34;arn:aws:iam::${ACCOUNT_ID}:oidc-provider/${OIDC_PROVIDER}&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      },
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      &#34;Action&#34;: &#34;sts:AssumeRoleWithWebIdentity&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      &#34;Condition&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        &#34;StringEquals&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          &#34;${OIDC_PROVIDER}:sub&#34;: &#34;system:serviceaccount:default:${VAULT_AUTH_K8S_SERVICE_ACCOUNT}&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  ]
</span></span></span><span style=display:flex><span><span style=color:#e6db74>}
</span></span></span><span style=display:flex><span><span style=color:#e6db74>EOF</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>VAULT_AUTH_ROLE_ARN<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>aws iam create-role <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --role-name $VAULT_AUTH_ROLE_NAME <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --assume-role-policy-document file://<span style=color:#e6db74>${</span>VAULT_AUTH_ROLE_NAME<span style=color:#e6db74>}</span>.trust.json <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --description <span style=color:#e6db74>&#34;Defines Pod identity for Vault AWS authentication&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --query Role.Arn <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --output text<span style=color:#66d9ef>)</span>
</span></span></code></pre></div><p>Now let&rsquo;s create and annotate a Kubernetes service account with this IAM Role and validate the caller identity within a pod.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl create sa $VAULT_AUTH_K8S_SERVICE_ACCOUNT
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>kubectl annotate sa $VAULT_AUTH_K8S_SERVICE_ACCOUNT eks.amazonaws.com/role-arn<span style=color:#f92672>=</span>$VAULT_AUTH_ROLE_ARN
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>kubectl run awscli -it --rm --restart<span style=color:#f92672>=</span>Never --serviceaccount $VAULT_AUTH_K8S_SERVICE_ACCOUNT --image amazon/aws-cli sts get-caller-identity
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;UserId&#34;</span>: <span style=color:#e6db74>&#34;AROA6HH0000000CRMM46T:botocore-session-1621778135&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;Account&#34;</span>: <span style=color:#e6db74>&#34;123456789012&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;Arn&#34;</span>: <span style=color:#e6db74>&#34;arn:aws:sts::123456789012:assumed-role/vault-auth/botocore-session-1621778135&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>pod <span style=color:#e6db74>&#34;awscli&#34;</span> deleted
</span></span></code></pre></div><p>You should see the ARN output of the last command referring to the previously created IAM role for Vault.</p><p>Now, let&rsquo;s get back to our Vault instance running locally and create a Vault role to satisfy this new identity.</p><p>Start a container to perform the Vault client commands. Note that this container is a convenience to use the Vault client, if you have a Vault client installed in your machine you can just point it to the Vault server running in Docker.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>docker run --rm -it <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -e VAULT_ADDR<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;http://localhost:8200&#39;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -e VAULT_TOKEN<span style=color:#f92672>=</span>mytoken <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --net<span style=color:#f92672>=</span>host vault /bin/sh
</span></span></code></pre></div><p>Let&rsquo;s create the Vault AWS role. Change the <code>bound_iam_principal_arn</code> below with the Vault IAM Role created before - you can check this out with <code>echo $VAULT_AUTH_ROLE_ARN</code>. Run from inside the container.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>vault write auth/aws/role/dev-role-iam2 auth_type<span style=color:#f92672>=</span>iam <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    bound_iam_principal_arn<span style=color:#f92672>=</span>arn:aws:iam::123456789012:role/vault-auth <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    policies<span style=color:#f92672>=</span>dev <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    max_ttl<span style=color:#f92672>=</span>768h
</span></span></code></pre></div><p>Exit the container.</p><p>Make sure ngrok is still running and the URL is still the same.</p><p>Run a pod to perform the Vault authentication using the new role and the pod identity.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl run vault -it --rm --restart<span style=color:#f92672>=</span>Never <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --serviceaccount $VAULT_AUTH_K8S_SERVICE_ACCOUNT <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --image vault -- <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    vault login -address<span style=color:#f92672>=</span>http://2a7f0319443a.ngrok.io <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -method<span style=color:#f92672>=</span>aws <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    role<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;dev-role-iam2&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>If you don<span style=color:#960050;background-color:#1e0010>&#39;</span>t see a command prompt, try pressing enter.
</span></span><span style=display:flex><span>Success! You are now authenticated. The token information displayed below
</span></span><span style=display:flex><span>is already stored in the token helper. You <span style=color:#66d9ef>do</span> NOT need to run <span style=color:#e6db74>&#34;vault login&#34;</span>
</span></span><span style=display:flex><span>again. Future Vault requests will automatically use this token.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Key                      Value
</span></span><span style=display:flex><span>---                      -----
</span></span><span style=display:flex><span>token                    s.RSqVT87jxMwPjZOS9gv6N7eg
</span></span><span style=display:flex><span>token_accessor           gyU6SDHP3YJ6yIDeGESc0loO
</span></span><span style=display:flex><span>token_duration           768h
</span></span><span style=display:flex><span>token_renewable          true
</span></span><span style=display:flex><span>token_policies           <span style=color:#f92672>[</span><span style=color:#e6db74>&#34;default&#34;</span> <span style=color:#e6db74>&#34;dev&#34;</span><span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>identity_policies        <span style=color:#f92672>[]</span>
</span></span><span style=display:flex><span>policies                 <span style=color:#f92672>[</span><span style=color:#e6db74>&#34;default&#34;</span> <span style=color:#e6db74>&#34;dev&#34;</span><span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>token_meta_account_id    <span style=color:#ae81ff>123456789012</span>
</span></span><span style=display:flex><span>token_meta_auth_type     iam
</span></span><span style=display:flex><span>token_meta_role_id       f4588750-45cc-19f2-b7d1-1c570979dcc3
</span></span><span style=display:flex><span>pod <span style=color:#e6db74>&#34;vault&#34;</span> deleted
</span></span></code></pre></div><p>If everything is ok, you should see the Vault token as in the output above. Make changes in the Vault role and note how the login will fail if you provide an invalid principal ARN. You can also experiment with a different non-authorized Kubernetes service account to see what happens.</p><h2 id=optional-iam-roles-for-service-accounts-overview>Optional: IAM Roles for Service Accounts Overview</h2><p>Instead of using the Node IAM Role, the IAM Roles for Service Accounts feature makes pods first-class citizens in IAM, enabling the AWS identity APIs to recognize Kubernetes pods. This approach uses an OpenID Connect (OIDC) identity provider and Kubernetes service account annotations to allow a Pod to assume an AWS IAM role.</p><p>The flow works as follows, from the docs:</p><blockquote><p>OIDC federation allows the user to assume IAM roles with the Secure Token Service (STS), effectively receiving a JSON Web Token (JWT) via an OAuth2 flow that can be used to assume an IAM role with an OIDC provider. In Kubernetes we then use projected service account tokens, which are valid OIDC JWTs, giving each pod a cryptographically-signed token which can be verified by STS against the OIDC provider for establishing identity.</p></blockquote><p>To simplify things on our side, a mutating admission controller running in EKS (via a webhook) automatically injects in the pod the necessary environment variables and a volume with a <a href=https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/#service-account-token-volume-projection>projected service account token</a>. The admission controller is just a utility, this step can also be made manually.</p><p>Check the blog post <a href=https://aws.amazon.com/blogs/opensource/introducing-fine-grained-iam-roles-service-accounts/>Introducing fine-grained IAM roles for service accounts</a> and the <a href=https://docs.aws.amazon.com/eks/latest/userguide/iam-roles-for-service-accounts-technical-overview.html>AWS IAM Roles for Service Accounts documentation</a> for more details.</p><h2 id=optional-terraform-configuration>Optional: Terraform configuration</h2><p>In this tutorial we used the AWS and Vault CLI&rsquo;s for the configuration. If you are interested in the Terraform approach for the same configuration we did here, please, check <a href=https://gist.github.com/soeirosantos/1ac8478c917ea47bd092974c9a96c003>this gist</a>.</p><h2 id=clean-up>Clean up</h2><p>To avoid costs with EKS and to remove the IAM resources created in this tutorial, execute the following commands.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>eksctl delete cluster --name $CLUSTER_NAME
</span></span><span style=display:flex><span>aws iam detach-user-policy --user-name vault-auth --policy-arn $VAULT_AUTH_POLICY_ARN
</span></span><span style=display:flex><span>aws iam delete-policy --policy-arn $VAULT_AUTH_POLICY_ARN
</span></span><span style=display:flex><span>aws iam delete-access-key --user-name $VAULT_AUTH_USER_NAME --access-key-id<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span><span style=color:#66d9ef>$(</span>jq -r .AccessKey.AccessKeyId &lt; access_key.json<span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>aws iam delete-user --user-name $VAULT_AUTH_USER_NAME
</span></span><span style=display:flex><span>aws iam delete-role --role-name $VAULT_AUTH_ROLE_NAME
</span></span></code></pre></div></div><footer class=post__footer><div class="post__tags tags clearfix"><svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M32 19c0 1-1 2-1 2L21 31s-1 1-2 1-2-1-2-1L2 16c-1-1-1.4-2-1.4-2S0 12.5.0 11V3C0 1.5.8.8.8.8S1.5.0 3 0h8c1.5.0 3 .6 3 .6S15 1 16 2l15 15s1 1 1 2zM7 10a3 3 0 100-6 3 3 0 000 6z"/></svg><ul class=tags__list><li class=tags__item><a class="tags__link btn" href=/tags/devsecops/ rel=tag>devsecops</a></li><li class=tags__item><a class="tags__link btn" href=/tags/kubernetes/ rel=tag>kubernetes</a></li><li class=tags__item><a class="tags__link btn" href=/tags/aws/ rel=tag>aws</a></li><li class=tags__item><a class="tags__link btn" href=/tags/eks/ rel=tag>eks</a></li><li class=tags__item><a class="tags__link btn" href=/tags/vault/ rel=tag>vault</a></li></ul></div></footer></article></main></div></div><footer class=footer><div class="container footer__container flex"><div class=footer__copyright>&copy; 2023 Deployment - Software Development, Security and Operations.
<span class=footer__copyright-credits>Generated with <a href=https://gohugo.io/ rel="nofollow noopener" target=_blank>Hugo</a> and <a href=https://github.com/Vimux/Mainroad/ rel="nofollow noopener" target=_blank>Mainroad</a> theme.</span></div></div></footer></div><script async defer src=/js/menu.js></script>
<script src=/js/custom.js></script></body></html>